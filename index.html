<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Habit Cards App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --page-padding: 16px;
      /* iOS-FIX: 100svh statt 100vh */
      --card-height: calc((100svh - 16px*5 - 60px - env(safe-area-inset-bottom)) / 3);
    }

    * { margin:0; padding:0; box-sizing:border-box; user-select:none; -webkit-user-select:none; }

    /* iOS FIX */
    body { 
      height:100svh; 
      background:#fff; 
      overflow:hidden; 
      font-family:-apple-system,system-ui; 
    }

    .page { height:100%; display:flex; flex-direction:column; padding:16px; padding-bottom:140px; gap:16px; }
    .cards { flex:1; display:flex; flex-direction:column; gap:16px; }
    .slot { position:relative; height:var(--card-height); perspective:1200px; }

    .card {
      position:absolute; inset:0;
      border-radius:24px;
      background:#e4e4e4;
      padding:24px;
      transform-style:preserve-3d;
      cursor:pointer;
      opacity:0;
      transition:transform 0.2s linear;
    }

    .card-face { position:absolute; inset:0; backface-visibility:hidden; border-radius:24px; padding:24px; }
    .front { background:transparent; }

    .back {
      background:#e4e4e4;
      transform:rotateY(180deg);
      display:flex; flex-direction:row; justify-content:space-between;
      padding:24px;
    }

    .half {
      width:50%; display:flex; justify-content:center; align-items:center;
      font-size:2rem; font-weight:800; color:#777;
    }

    .card-input {
      position:absolute;
      bottom:24px; left:24px;
      width:60%;
      font-size:2rem; font-weight:800;
      border:none; background:transparent; outline:none;
      color:#666;
    }
    .card-input::placeholder { color:#999; }

    .counter {
      position:absolute;
      bottom:24px;
      right:24px;
      background:#fff;
      padding:4px 12px;
      border-radius:999px;
      border:2px solid #000;
      font-size:1.2rem;
      font-weight:700;
      display:none;
    }

    .buttons-row {
      position:fixed;
      left:0; right:0; bottom:0;
      padding:0 16px calc(16px + env(safe-area-inset-bottom));
      height:calc(60px + env(safe-area-inset-bottom));
      background:#fff;
      display:flex; gap:12px;
      z-index:9999;
    }

    .btn-half {
      flex:1; height:60px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:1.5rem; border:none; cursor:pointer;
    }

    .btn-plus { background:#000; color:#fff; }
    .btn-stats { background:#f3f3f3; border:2px solid #ccc; color:#333; }

    #statsView {
      position:fixed;
      left:0; right:0; top:100svh; bottom:0;   /* iOS-FIX */
      background:#fff;
      padding:24px;
      padding-bottom:140px;
      overflow-y:auto;
      z-index:50;
    }

    .stats-name { font-size:2rem; font-weight:700; margin-bottom:20px; }
    .stat-bar { width:100%; height:48px; background:#e5e7eb; border-radius:16px; margin-bottom:18px; overflow:hidden; }
    .stat-fill {
      height:100%;
      width:0;
      padding-left:12px;
      display:flex;
      align-items:center;
      font-weight:700;
      border-radius:16px;
      color:#000;
    }
  </style>
</head>
<body>

<div class="page">
  <div class="cards">
    <div class="slot" id="slot1"></div>
    <div class="slot" id="slot2"></div>
    <div class="slot" id="slot3"></div>
  </div>
</div>

<div class="buttons-row">
  <button class="btn-half btn-plus" id="addBtn" data-mode="add">+</button>
  <button class="btn-half btn-stats" id="statsBtn"><i data-lucide="bar-chart-2"></i></button>
</div>

<div id="statsView">
  <div class="stats-name">Kevin</div>
  <div class="stat-bar"><div class="stat-fill" id="k1"></div></div>
  <div class="stat-bar"><div class="stat-fill" id="k2"></div></div>
  <div class="stat-bar"><div class="stat-fill" id="k3"></div></div>

  <div style="height:40px"></div>

  <div class="stats-name">Hannah</div>
  <div class="stat-bar"><div class="stat-fill" id="h1"></div></div>
  <div class="stat-bar"><div class="stat-fill" id="h2"></div></div>
  <div class="stat-bar"><div class="stat-fill" id="h3"></div></div>
</div>

<script>
lucide.createIcons();

const slotOrder=["slot3","slot2","slot1"];
let count=0;

const cycleColors=[
  "#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e",
  "#10b981","#14b8a6","#06b6d4","#0ea5e9","#3b82f6","#6366f1",
  "#8b5cf6","#a855f7","#d946ef","#ec4899","#f43f5e","#dc2626",
  "#ea580c","#ca8a04","#4d7c0f","#15803d","#047857","#0f766e",
  "#0369a1","#1d4ed8","#4338ca","#6d28d9","#7e22ce","#be185d"
];

function darken(hex,f=0.55){
  let r=parseInt(hex.slice(1,3),16)*f|0;
  let g=parseInt(hex.slice(3,5),16)*f|0;
  let b=parseInt(hex.slice(5,7),16)*f|0;
  return `rgb(${r},${g},${b})`;
}

let swipeStartX=0;
let swipeEndX=0;
let autoFlipTimer=null;

// -------------------------------------
//  ADD CARD
// -------------------------------------
addBtn.addEventListener("click",()=>{

  if(addBtn.dataset.mode==="home"){
    gsap.to("#statsView",{top:"100svh",duration:0.6,ease:"power3.in"});
    addBtn.textContent="+";
    addBtn.classList.add("btn-plus");
    addBtn.style.background="#000";
    addBtn.style.color="#fff";
    addBtn.style.border="none";
    addBtn.dataset.mode="add";
    return;
  }

  if(count>=3) return;

  const slot=document.getElementById(slotOrder[count]);

  const card=document.createElement("div");
  card.className="card";
  card.dataset.index=count;
  card.dataset.active="false";
  card.dataset.color="#e4e4e4";
  card.dataset.goal="0";    
  card.dataset.progress="0";

  card.innerHTML=`
    <div class="card-face front">
      <input class="card-input" placeholder="Titel eingeben..." />
      <div class="counter"></div>
    </div>

    <div class="card-face back">
      <div class="half" id="gpsArea">
        <i data-lucide="map-pin" style="width:32px;height:32px;color:#777;"></i>
      </div>
      <div class="half" id="numArea">0</div>
    </div>
  `;

  slot.appendChild(card);
  lucide.createIcons();

  const input=card.querySelector(".card-input");
  const counter=card.querySelector(".counter");
  const gpsArea=card.querySelector("#gpsArea");
  const numArea=card.querySelector("#numArea");

  gsap.fromTo(card,{y:-300,opacity:0},{y:0,opacity:1,duration:0.8,ease:"back.out(1.7)"});


  // -------------------------------------
  // SWIPE FLIP
  // -------------------------------------
  card.addEventListener("touchstart",(e)=>{
    swipeStartX = e.touches[0].clientX;
    clearTimeout(autoFlipTimer);
  });

  card.addEventListener("touchmove",(e)=>{
    swipeEndX = e.touches[0].clientX;
  });

  card.addEventListener("touchend",()=>{
    const dx = swipeEndX - swipeStartX;

    if(dx < -40 && !card.style.transform.includes("180deg")){
      gsap.to(card,{rotationY:180,duration:0.4,ease:"power2.out"});
    }
    if(dx > 40 && card.style.transform.includes("180deg")){
      gsap.to(card,{rotationY:0,duration:0.4,ease:"power2.out"});
    }

    autoFlipTimer=setTimeout(()=>{
      if(card.style.transform.includes("180deg")){
        gsap.to(card,{rotationY:0,duration:0.5,ease:"power2.out"});
      }
    },3000);
  });


  // -------------------------------------
  // Y einstellen (0–7)
  // -------------------------------------
  numArea.addEventListener("click",(e)=>{
    e.stopPropagation();
    let y=parseInt(card.dataset.goal);
    y=(y+1)%8;
    card.dataset.goal=y;
    numArea.textContent=y;

    if(y>0) counter.style.display="block";
    else counter.style.display="none";

    counter.textContent=card.dataset.progress+"/"+y;
  });

  gpsArea.addEventListener("click",(e)=>{
    e.stopPropagation();
    gsap.to(card,{rotationY:0,duration:0.4,ease:"power2.out"});
  });


  // -------------------------------------
  // LONG PRESS COLOR CYCLING
  // -------------------------------------
  let pressTimer=null;
  let pressInterval=null;

  card.addEventListener("touchstart",(e)=>{
    clearTimeout(pressTimer);
    clearInterval(pressInterval);

    pressTimer=setTimeout(()=>{
      if(card.dataset.active==="true"){
        let i=0;
        pressInterval=setInterval(()=>{
          const col=cycleColors[i%cycleColors.length];
          card.style.background=col;
          card.dataset.color=col;
          input.style.color=darken(col);
          i++;
        },900);
      }
    },300);
  });

  card.addEventListener("touchend",()=>{
    clearTimeout(pressTimer);
    clearInterval(pressInterval);
  });


  // -------------------------------------
  // CLICK: x hoch/runter + Farbe toggeln
  // -------------------------------------
  card.addEventListener("click",()=>{

    if(card.style.transform.includes("180deg")) return;
    if(!input.value.trim()){ return; }

    let activeBefore = card.dataset.active==="true";
    let x = parseInt(card.dataset.progress);
    let y = parseInt(card.dataset.goal);

    if(y>0) counter.style.display="block";

    if(!activeBefore){
      if(y>0 && x<y) x++;
    } else {
      if(y>0 && x>0) x--;
    }

    card.dataset.progress=x;
    counter.textContent=x+"/"+y;

    const idx=parseInt(card.dataset.index);
    if(activeBefore){
      card.dataset.active="false";
      card.style.background="#e4e4e4";
      card.dataset.color="#e4e4e4";
      input.style.color="#666";
    } else {
      const col=cycleColors[idx];
      card.dataset.active="true";
      card.style.background=col;
      card.dataset.color=col;
      input.style.color=darken(col);
    }
  });

  count++;
});


// -------------------------------------
// STATISTIKEN
// -------------------------------------
function renderStats() {

  const cards = document.querySelectorAll(".card");
  const statIds = ["k1","k2","k3"];

  statIds.forEach((id,i)=>{
    const bar = document.getElementById(id);

    if(!cards[i]) {
      bar.style.width = "0%";
      bar.style.background = "#e5e7eb";
      bar.textContent = "";
      return;
    }

    const input = cards[i].querySelector(".card-input");
    const title = input.value.trim() || "—";

    const color = cards[i].dataset.color || "#e5e7eb";
    const x = parseInt(cards[i].dataset.progress);
    const y = parseInt(cards[i].dataset.goal);

    let percent = 0;
    if(y > 0) percent = Math.round((x / y) * 100);

    bar.textContent = title;
    bar.style.background = color;

    gsap.fromTo(bar, { width: "0%" }, {
      width: percent + "%",
      duration: 1.2,
      ease: "power3.out"
    });
  });

  ["h1","h2","h3"].forEach(id=>{
    const bar=document.getElementById(id);
    gsap.fromTo(bar,{width:"0%"},{
      width:(40+Math.random()*60)+"%",
      duration:1.2
    });
  });
}


// -------------------------------------
// OPEN STATISTICS
// -------------------------------------
statsBtn.addEventListener("click",()=>{

  renderStats();

  addBtn.dataset.mode="home";
  addBtn.innerHTML='<i data-lucide="house"></i>';
  addBtn.classList.remove("btn-plus");
  addBtn.style.background="#f3f3f3";
  addBtn.style.color="#333";
  addBtn.style.border="2px solid #ccc";

  lucide.createIcons();
  gsap.to("#statsView",{top:0,duration:0.6,ease:"power3.out"});
});

</script>
</body>
</html>