<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Habit App</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Matter.js Physik -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

  <style>
    :root {
      --black:#000;
      --white:#fff;
      --gray:#e5e5e5;
      --lightgray:#f2f2f2;
    }

    body {
      margin:0;
      background:var(--white);
      color:var(--black);
      font-family:system-ui,-apple-system,sans-serif;
      height:100vh;
      overflow:hidden;
      position:relative;
    }

    .screen {
      display:none;
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }
    .screen.active {
      display:flex;
    }

    /* Login-Screen */
    #loginScreen {
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }

    @keyframes pulse {
      0%   { transform:scale(1); }
      50%  { transform:scale(1.06); }
      100% { transform:scale(1); }
    }

    #loginCircle {
      width:30px;
      height:30px;
      background:#000;
      border-radius:50%;
      animation:pulse 2.2s ease-in-out infinite;
    }

    #loginHeadline {
      margin-top:28px;
      font-size:26px;
      font-weight:600;
      text-align:center;
      padding:0 20px;
    }

    #loginButtonBar {
      position:absolute;
      bottom:24px;
      left:0;
      width:100%;
      display:flex;
      gap:14px;
      padding:0 20px;
      box-sizing:border-box;
      transition:bottom .25s ease;
    }

    .btn {
      flex:1;
      padding:14px;
      border:none;
      border-radius:20px;
      font-size:17px;
    }

    #btnLogin    { background:#000; color:#fff; }
    #btnRegister { background:#e5e5e5; color:#000; }

    #loginForm {
      display:none;
      flex-direction:column;
      gap:12px;
      padding:20px;
      width:100%;
      max-width:600px;
      box-sizing:border-box;
    }

    .login-input {
      padding:12px;
      border:none;
      border-radius:12px;
      background:#e5e5e5;
      font-size:16px;
    }

    /* Hauptscreen */
    #mainScreen {
      flex-direction:column;
      padding:20px;
      padding-bottom:100px;
      box-sizing:border-box;
      overflow-y:auto;
    }

    #topStatsBox {
      width:100%;
      max-width:600px;
      margin:0 auto 20px auto;
      background:var(--gray);
      border-radius:18px;
      padding:16px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    #progressLabel {
      font-size:15px;
      font-weight:600;
      opacity:.8;
    }

    .progress {
      width:100%;
      height:12px;
      background:var(--lightgray);
      border-radius:6px;
      overflow:hidden;
    }

    .progress-inner {
      height:100%;
      width:0%;
      background:#000;
      transition:width .3s ease;
    }

    #progressText {
      font-size:13px;
      opacity:.8;
    }

    #habitList {
      position:relative;
      width:100%;
      max-width:600px;
      margin:0 auto;
      min-height:360px;
      box-sizing:border-box;
    }

    /* Quadratische Karten */
    .habitCard {
      position:absolute;
      width:100px;
      height:100px;
      border:3px solid var(--black);
      border-radius:20px;
      box-sizing:border-box;
      padding:14px;
      display:flex;
      justify-content:center;
      align-items:center;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
      color:#000;
      will-change:transform;
      touch-action:none; /* wichtig für sauberes Draggen */
    }

    .habitCard-title {
      font-size:18px;
      font-weight:600;
      line-height:1.3;
    }

    /* Overlay neue Habit */
    #newHabitOverlay {
      position:absolute;
      inset:0;
      display:none;
      justify-content:center;
      align-items:center;
      z-index:40;
      backdrop-filter:blur(2px);
    }

    #newHabitCard {
      background:#e5e5e5;
      border-radius:18px;
      padding:20px;
      width:100%;
      max-width:360px;
      box-shadow:0 8px 30px rgba(0,0,0,0.2);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    #newHabitTitle {
      padding:14px;
      border-radius:12px;
      border:none;
      background:#fff;
      font-size:16px;
    }

    #newHabitOkBtn {
      padding:12px;
      border-radius:14px;
      border:none;
      background:#000;
      color:#fff;
      font-size:17px;
    }

    /* Plus-Button unten */
    #bottomActionBar {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      width:calc(100% - 40px);
      max-width:600px;
      padding:10px 14px;
      background:#000;
      color:#fff;
      border-radius:18px;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:26px;
      font-weight:600;
      box-sizing:border-box;
      z-index:50;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="screen active">
  <div id="loginCircle"></div>
  <div id="loginHeadline">Hallo, bitte melde dich an, um deine Gewohnheiten zu sehen</div>

  <div id="loginButtonBar">
    <button id="btnLogin" class="btn">Login</button>
    <button id="btnRegister" class="btn">Registrieren</button>
  </div>

  <div id="loginForm">
    <input id="loginEmail" type="email" placeholder="E-Mail" class="login-input" />
    <input id="loginPassword" type="password" placeholder="Passwort" class="login-input" />
    <button id="loginOkBtn" class="btn" style="background:#000;color:#fff;">OK</button>
  </div>
</div>

<!-- MAIN -->
<div id="mainScreen" class="screen">
  <div id="topStatsBox">
    <div id="progressLabel">Fortschritt</div>
    <div class="progress">
      <div class="progress-inner" id="progressInner"></div>
    </div>
    <div id="progressText">0 / 0 erledigt</div>
  </div>

  <div id="habitList"></div>

  <div id="newHabitOverlay">
    <div id="newHabitCard">
      <div style="font-size:20px;font-weight:600;">Neue Gewohnheit</div>
      <input id="newHabitTitle" placeholder="Titel..." />
      <button id="newHabitOkBtn">OK</button>
    </div>
  </div>
</div>

<div id="bottomActionBar">+</div>

<script>
  /* Supabase init */
  const { createClient } = supabase;
  const supabaseClient = createClient("https://gglgenarpskajkaanknk.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdnbGdlbmFycHNrYWprYWFua25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODA2NzAsImV4cCI6MjA3ODY1NjY3MH0.phVPaPpkiXJ0ncbRiBChpVBtY8gv0sm_MjlCJJnaSt4");

  /* Matter.js Alias */
  const Engine = Matter.Engine;
  const World  = Matter.World;
  const Bodies = Matter.Bodies;
  const Body   = Matter.Body;

  let engine = null;
  let world  = null;
  let physicsInitialized = false;

  const CARD_SIZE = 160;
  const CARD_HALF = CARD_SIZE / 2;
  const pastelColors = ["#FFE8A3","#CFFFD8","#D6E5FF","#FFD6E8","#E9DAFF","#FFF2C7"];

  /* Wander-Parameter */
  const MAX_SPEED       = 2.0;
  const MIN_SPEED       = 0.3;
  const WANDER_FORCE    = 0.0008;
  const WANDER_INTERVAL = 200; // ms

  /* Flick-Thresholds */
  const FLICK_DISTANCE = 80;
  const FLICK_SPEED    = 600;
  const OFFSCREEN_MARGIN = 120;

  const loginScreen     = document.getElementById("loginScreen");
  const mainScreen      = document.getElementById("mainScreen");
  const loginForm       = document.getElementById("loginForm");
  const loginButtonBar  = document.getElementById("loginButtonBar");
  const loginEmail      = document.getElementById("loginEmail");
  const loginPassword   = document.getElementById("loginPassword");
  const habitListEl     = document.getElementById("habitList");
  const bottomActionBar = document.getElementById("bottomActionBar");
  const newHabitOverlay = document.getElementById("newHabitOverlay");
  const newHabitTitle   = document.getElementById("newHabitTitle");
  const progressInner   = document.getElementById("progressInner");
  const progressText    = document.getElementById("progressText");
  const newHabitOkBtn   = document.getElementById("newHabitOkBtn");
  const btnLogin        = document.getElementById("btnLogin");
  const btnRegister     = document.getElementById("btnRegister");
  const loginOkBtn      = document.getElementById("loginOkBtn");

  let habitBodies = []; // { body, el }
  let walls = [];
  let addMode = false;

  /* Login-Buttons */
  btnLogin.onclick = () => {
    loginForm.style.display = "flex";
    loginForm.dataset.mode = "login";
    loginButtonBar.style.bottom = "260px";
  };

  btnRegister.onclick = () => {
    loginForm.style.display = "flex";
    loginForm.dataset.mode = "register";
    loginButtonBar.style.bottom = "260px";
  };

  loginOkBtn.onclick = async () => {
    const email = loginEmail.value;
    const password = loginPassword.value;
    const mode = loginForm.dataset.mode;

    if (mode === "login") {
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (!error) {
        loginScreen.classList.remove("active");
        mainScreen.classList.add("active");
        await ensurePhysics();
        loadHabits();
      } else {
        alert("Login fehlgeschlagen");
      }
    }

    if (mode === "register") {
      const { error } = await supabaseClient.auth.signUp({ email, password });
      if (!error) alert("Registrierung erfolgreich – bitte E-Mail bestätigen.");
      else alert("Registrierung fehlgeschlagen.");
    }
  };

  /* Physik initialisieren */
  async function ensurePhysics() {
    if (physicsInitialized) return;
    physicsInitialized = true;

    engine = Engine.create();
    world  = engine.world;
    engine.gravity.x = 0;
    engine.gravity.y = 0;

    createBounds();

    let lastTime = performance.now();
    function tick(now) {
      const delta = now - lastTime;
      lastTime = now;
      Engine.update(engine, delta);

      updateDomFromPhysics();
      checkOffscreenFlicks();

      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // Endloses Wanderverhalten
    setInterval(() => {
      habitBodies.forEach(({ body }) => {
        if (!body) return;
        const vx = body.velocity.x;
        const vy = body.velocity.y;
        const speed = Math.sqrt(vx*vx + vy*vy);

        // zu langsam → neuer Impuls
        if (speed < MIN_SPEED) {
          const angle = Math.random() * Math.PI * 2;
          Body.applyForce(body, body.position, {
            x: Math.cos(angle) * WANDER_FORCE,
            y: Math.sin(angle) * WANDER_FORCE
          });
          return;
        }

        // zu schnell → leicht bremsen
        if (speed > MAX_SPEED) {
          Body.setVelocity(body, {
            x: vx * 0.9,
            y: vy * 0.9
          });
          return;
        }

        // normal → kleiner wander-Impuls
        const angle = Math.random() * Math.PI * 2;
        Body.applyForce(body, body.position, {
          x: Math.cos(angle) * WANDER_FORCE,
          y: Math.sin(angle) * WANDER_FORCE
        });
      });
    }, WANDER_INTERVAL);
  }

  /* Begrenzungen */
  function createBounds() {
    const rect = habitListEl.getBoundingClientRect();
    const w = rect.width;
    const h = rect.height;
    const thickness = 80;

    if (walls.length) {
      walls.forEach(wb => World.remove(world, wb));
      walls = [];
    }

    const left   = Bodies.rectangle(-thickness/2, h/2, thickness, h + thickness, { isStatic:true });
    const right  = Bodies.rectangle(w + thickness/2, h/2, thickness, h + thickness, { isStatic:true });
    const top    = Bodies.rectangle(w/2, -thickness/2, w + thickness, thickness, { isStatic:true });
    const bottom = Bodies.rectangle(w/2, h + thickness/2, w + thickness, thickness, { isStatic:true });

    walls.push(left, right, top, bottom);
    World.add(world, walls);
  }

  /* Progress */
  function updateProgress(all) {
    const total = all.length;
    const done  = all.filter(h => h.zustand === "erledigt").length;
    const pct   = total > 0 ? (done / total) * 100 : 0;
    progressInner.style.width = pct + "%";
    progressText.textContent = `${done} / ${total} erledigt`;
  }

  /* Habits laden */
  async function loadHabits() {
    const user = (await supabaseClient.auth.getUser()).data.user;
    if (!user) return;

    const { data, error } = await supabaseClient
      .from("habits")
      .select("*")
      .eq("user_id", user.id)
      .order("created_at");

    if (error) {
      console.error(error);
      return;
    }

    updateProgress(data || []);

    const openHabits = (data || []).filter(h => h.zustand !== "erledigt");

    // alte Bodies entfernen
    habitBodies.forEach(({ body }) => World.remove(world, body));
    habitBodies = [];
    habitListEl.innerHTML = "";

    const rect = habitListEl.getBoundingClientRect();
    const w = rect.width;
    const h = rect.height;

    openHabits.forEach(habit => {
      const el = document.createElement("div");
      el.className = "habitCard";
      el.dataset.id = habit.id;
      el.style.background = pastelColors[Math.floor(Math.random() * pastelColors.length)];
      el.innerHTML = `<div class="habitCard-title">${habit.titel}</div>`;
      habitListEl.appendChild(el);

      const startX = CARD_HALF + Math.random() * (w - CARD_SIZE);
      const startY = CARD_HALF + Math.random() * (h - CARD_SIZE);

      const body = Bodies.rectangle(startX, startY, CARD_SIZE, CARD_SIZE, {
        frictionAir: 0.03,
        restitution: 0.9
      });
      body.habitId = habit.id;
      body.domEl   = el;
      body.armedForCompletion = false;
      body.markedDone = false;

      World.add(world, body);
      habitBodies.push({ body, el });

      // zufälliger Startschubs
      Body.setVelocity(body, {
        x:(Math.random()*2 - 1) * 1.0,
        y:(Math.random()*2 - 1) * 1.0
      });

      attachTouchHandlers(el, body);
    });
  }

  /* DOM-Positionen aus Physik */
  function updateDomFromPhysics() {
    const rect = habitListEl.getBoundingClientRect();
    const offsetX = rect.left;
    const offsetY = rect.top;

    habitBodies.forEach(({ body, el }) => {
      const x = body.position.x;
      const y = body.position.y;
      el.style.transform = `translate(${x - CARD_HALF}px, ${y - CARD_HALF}px)`;
    });
  }

  /* Offscreen-Erkennung für Flick */
  function checkOffscreenFlicks() {
    const rect = habitListEl.getBoundingClientRect();
    const w = rect.width;
    const h = rect.height;

    habitBodies.slice().forEach(({ body, el }) => {
      if (!body.armedForCompletion || body.markedDone) return;
      const x = body.position.x;
      const y = body.position.y;

      if (x < -OFFSCREEN_MARGIN ||
          x > w + OFFSCREEN_MARGIN ||
          y < -OFFSCREEN_MARGIN ||
          y > h + OFFSCREEN_MARGIN) {
        body.markedDone = true;
        completeHabit(body.habitId, body, el);
      }
    });
  }

  async function completeHabit(habitId, body, el) {
    World.remove(world, body);
    if (el && el.parentNode) el.parentNode.removeChild(el);

    await supabaseClient
      .from("habits")
      .update({ zustand: "erledigt" })
      .eq("id", habitId);

    loadHabits();
  }

  /* Drag / Flick */
  function attachTouchHandlers(el, body) {
    let dragging = false;
    let lastPositions = []; // {x,y,time}

    function containerRect() {
      return habitListEl.getBoundingClientRect();
    }

    el.addEventListener("touchstart", e => {
      if (addMode) return;
      dragging = true;
      lastPositions = [];
      const t = e.touches[0];
      const rect = containerRect();
      const x = t.clientX - rect.left;
      const y = t.clientY - rect.top;

      Body.setVelocity(body, {x:0,y:0});
      Body.setAngularVelocity(body, 0);

      lastPositions.push({x,y,time:performance.now()});
      e.preventDefault();
    }, { passive:false });

    el.addEventListener("touchmove", e => {
      if (!dragging || addMode) return;
      const t = e.touches[0];
      const rect = containerRect();
      const x = t.clientX - rect.left;
      const y = t.clientY - rect.top;

      Body.setPosition(body, {x,y});

      const now = performance.now();
      lastPositions.push({x,y,time:now});
      if (lastPositions.length > 5) lastPositions.shift();

      e.preventDefault();
    }, { passive:false });

    el.addEventListener("touchend", () => {
      if (!dragging) return;
      dragging = false;

      if (lastPositions.length < 2) {
        body.armedForCompletion = false;
        return;
      }

      const first = lastPositions[0];
      const last  = lastPositions[lastPositions.length - 1];
      const dt = (last.time - first.time) / 1000;
      const dx = last.x - first.x;
      const dy = last.y - first.y;

      if (dt <= 0) {
        body.armedForCompletion = false;
        return;
      }

      const vx = dx / dt;
      const vy = dy / dt;
      const speed = Math.sqrt(vx*vx + vy*vy);

      if (Math.hypot(dx,dy) > FLICK_DISTANCE && speed > FLICK_SPEED) {
        body.armedForCompletion = true;
        Body.setVelocity(body, {x:vx * 0.02, y:vy * 0.02});
      } else {
        body.armedForCompletion = false;
        Body.setVelocity(body, {x:vx * 0.01, y:vy * 0.01});
      }
    }, { passive:true });
  }

  /* Plus → Overlay */
  bottomActionBar.onclick = () => {
    if (addMode) return;
    addMode = true;
    newHabitOverlay.style.display = "flex";
    newHabitTitle.value = "";
    newHabitTitle.focus();
  };

  newHabitOkBtn.onclick = async () => {
    const title = newHabitTitle.value.trim();
    if (!title) return;

    const user = (await supabaseClient.auth.getUser()).data.user;
    if (!user) return;

    const { error } = await supabaseClient
      .from("habits")
      .insert({
        user_id: user.id,
        titel: title,
        zustand: "offen"
      });

    if (error) {
      alert("Fehler beim Speichern");
      return;
    }

    newHabitOverlay.style.display = "none";
    addMode = false;
    loadHabits();
  };
</script>
</body>
</html>