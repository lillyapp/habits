<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Habit Cards mit GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --page-padding: 16px;
      --card-height: calc((100vh - 16px*4 - 60px) / 3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #fff;
      height: 100vh;
      overflow: hidden;
    }

    .page {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: var(--page-padding);
      gap: var(--page-padding);
    }

    .cards {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--page-padding);
    }

    .slot {
      position: relative;
      height: var(--card-height);
      perspective: 1200px;
    }

    .card {
      position: absolute;
      inset: 0;
      border-radius: 24px;
      background: #e4e4e4;
      padding: 24px;

      transform-style: preserve-3d;
      opacity: 0;
      cursor: pointer;
    }

    .card-face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      border-radius: 24px;
      padding: 24px;
    }

    .front {
      background: transparent;
    }

    .back {
      background: #e4e4e4;
      transform: rotateY(180deg);

      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }

    .gps-big {
      width: 48px;
      height: 48px;
      stroke: #000;
    }

    .address-input {
      border: none;
      background: transparent;
      padding: 10px 16px;
      width: 70%;
      font-size: 1.2rem;
      border-bottom: 2px solid #000;
      outline: none;
      text-align: center;
    }

    .card-input {
      position: absolute;
      left: 24px;
      bottom: 24px;
      font-size: 2rem;
      font-weight: 800;
      border: none;
      outline: none;
      background: transparent;
      width: 70%;
      color: #666;
    }

    .card-input::placeholder {
      color: #999;
    }

    .gps-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 28px;
      height: 28px;
      stroke: #000;
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: pointer;
      pointer-events: auto;
    }

    .bottom-bar {
      width: 100%;
      height: 60px;
    }

    .add-btn {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 999px;
      background: #000;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="page">
    <div class="cards">
      <div class="slot" id="slot1"></div>
      <div class="slot" id="slot2"></div>
      <div class="slot" id="slot3"></div>
    </div>

    <div class="bottom-bar">
      <button class="add-btn" id="addBtn">+</button>
    </div>
  </div>

  <script>
    lucide.createIcons();

    const activeColors = ["#3b82f6", "#f97316", "#22c55e"];
    const titleColors  = ["#1e3a8a", "#b45309", "#166534"];

    const slotOrder = ["slot3", "slot2", "slot1"];
    let count = 0;

    // GEOCODING (Adresse → Koordinaten)
    async function geocodeAddress(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const res = await fetch(url, { headers: { "User-Agent": "HabitApp/1.0" }});
      const data = await res.json();
      if (!data.length) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    // Entfernung (km)
    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI/180;
      const dLon = (lon2 - lon1) * Math.PI/180;

      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2)**2;

      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // Wiggle
    function wiggle(card) {
      gsap.fromTo(card, { x: -6 }, { x: 6, duration: 0.08, repeat: 5, yoyo: true });
    }

    // Farben setzen
    function activateCard(card, input, i) {
      card.style.background = activeColors[i];
      input.style.color = titleColors[i];
      card.dataset.active = "true";
    }
    function deactivateCard(card, input) {
      card.style.background = "#e4e4e4";
      input.style.color = "#666";
      card.dataset.active = "false";
    }

    document.getElementById("addBtn").addEventListener("click", () => {
      if (count >= 3) return;

      const slotId = slotOrder[count];
      const slot = document.getElementById(slotId);

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.index = count;
      card.dataset.active = "false";
      card.dataset.gps = "false";

      card.innerHTML = `
        <div class="card-face front">
          <input class="card-input" placeholder="Titel eingeben..." />
          <i data-lucide="map-pin" class="gps-icon"></i>
        </div>

        <div class="card-face back">
          <i data-lucide="map-pin" class="gps-big"></i>
          <input class="address-input" placeholder="Adresse eingeben..." />
        </div>
      `;

      slot.appendChild(card);
      lucide.createIcons();

      // FALL-Animation
      gsap.fromTo(card,
        { y: -300, rotate: gsap.utils.random(-6, 6), opacity: 0 },
        { y: 0, rotate: 0, opacity: 1, duration: 0.8, ease: "back.out(1.7)" }
      );

      const input = card.querySelector(".card-input");
      const gpsBtn = card.querySelector(".gps-icon");
      const addressInput = card.querySelector(".address-input");

      // GPS Icon nur im Eingabefeld sichtbar
      input.addEventListener("focus", () => gpsBtn.style.opacity = 1);
      input.addEventListener("blur",  () => gpsBtn.style.opacity = 0);

      // Flip zu GPS-Konfiguration
      gpsBtn.addEventListener("click", e => {
        e.stopPropagation();
        gsap.to(card, { rotationY: 180, duration: 0.5 });
      });

      // Adresse speichern & Geocoden
      addressInput.addEventListener("keydown", async e => {
        if (e.key === "Enter") {
          e.preventDefault();
          addressInput.blur();

          const coords = await geocodeAddress(addressInput.value);
          if (!coords) { alert("Adresse nicht gefunden"); return; }

          card.dataset.lat = coords.lat;
          card.dataset.lon = coords.lon;
          card.dataset.gps = "true";

          gsap.to(card, { rotationY: 0, duration: 0.5 });
        }
      });

      // Titel bestätigen per Enter
      input.addEventListener("keydown", e => {
        if (e.key === "Enter") input.blur();
      });

      // Karte anklicken → GPS-Modus oder Normalmodus
      card.addEventListener("click", e => {
        if (e.target === input || e.target === gpsBtn) return;

        // GPS-Aufgabe
        if (card.dataset.gps === "true") {
          navigator.geolocation.getCurrentPosition(pos => {
            const userLat = pos.coords.latitude;
            const userLon = pos.coords.longitude;

            const targetLat = parseFloat(card.dataset.lat);
            const targetLon = parseFloat(card.dataset.lon);

            const dist = distance(userLat, userLon, targetLat, targetLon);

            if (dist < 0.05) {
              activateCard(card, input, card.dataset.index);
            } else {
              wiggle(card);
            }
          });
          return;
        }

        // Normaler Toggle
        const i = parseInt(card.dataset.index);
        const isActive = card.dataset.active === "true";
        isActive ? deactivateCard(card, input) : activateCard(card, input, i);
      });

      count++;
    });
  </script>
</body>
</html>