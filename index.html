<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Consistency</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/lillyapp/habits/refs/heads/main/3FC2E555-7142-43BE-83DE-E5ED7A123793.png">

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <style>
    :root {
      --page-padding: 16px;
      --card-height: calc((100svh - 16px*5 - 60px - env(safe-area-inset-bottom)) / 3);
    }

    * {
      margin:0;
      padding:0;
      box-sizing:border-box;
      user-select:none;
      -webkit-user-select:none;
    }

    body {
      margin:0;
      padding:0;
      font-family: "Poppins", sans-serif;
      background:#fff;
      color:#000;
      height:100svh;
      overflow:hidden;
    }

    /* LOGIN */
    #loginScreen {
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      padding:20px;
      z-index:20;
      background:#fff;
      opacity:1;
      transition:opacity 0.4s ease;
    }

    @keyframes pulse {
      0% {transform:scale(1);}
      50%{transform:scale(1.06);}
      100%{transform:scale(1);}
    }

    #loginCircle {
      width:30px;
      height:30px;
      background:#000;
      border-radius:50%;
      animation:pulse 2.2s ease-in-out infinite;
    }

    #loginHeadline {
      margin-top:28px;
      font-size:26px;
      font-weight:600;
      text-align:center;
    }

    #loginButtonBar {
      width:100%;
      max-width:400px;
      display:flex;
      gap:14px;
      margin-top:50px;
    }

    .btn {
      flex:1;
      padding:14px;
      border-radius:20px;
      border:none;
      font-size:17px;
      cursor:pointer;
    }

    #btnLogin    {background:#000; color:#fff;}
    #btnRegister {background:#e5e5e5; color:#000;}

    #loginForm {
      width:100%;
      max-width:400px;
      display:none;
      flex-direction:column;
      gap:12px;
      margin-top:30px;
    }

    .login-input {
      padding:12px;
      border:none;
      border-radius:12px;
      background:#e5e5e5;
    }

    #loginError {
      margin-top:12px;
      color:#ef4444;
      font-size:14px;
      display:none;
      text-align:center;
    }

    /* MAIN PAGE (Habit-Klötze) */
    #appPage {
      position:absolute;
      inset:0;
      display:none;
      opacity:0;
    }

    .page {
      height:100%;
      display:flex;
      flex-direction:column;
      padding:16px;
      padding-bottom:140px;
      gap:16px;
    }

    .cards {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .slot {
      position:relative;
      height:var(--card-height);
      perspective:1200px;
    }

    .card {
      position:absolute;
      inset:0;
      border-radius:24px;
      background:#e4e4e4;
      padding:24px;
      transform-style:preserve-3d;
      cursor:pointer;
      opacity:0;
      transition:transform 0.25s linear;
    }

    .card-face {
      position:absolute;
      inset:0;
      backface-visibility:hidden;
      border-radius:24px;
      padding:24px;
    }

    .front { background:transparent; }

    .back {
      background:#e4e4e4;
      transform:rotateY(180deg);
      display:flex;
      flex-direction:row;
      justify-content:space-between;
      padding:24px;
    }

    .half {
      width:50%;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:2rem;
      font-weight:800;
      color:#777;
    }

    .card-input {
      position:absolute;
      bottom:24px;
      left:24px;
      width:60%;
      font-size:2rem;
      font-weight:800;
      border:none;
      background:transparent;
      outline:none;
      color:#666;
    }

    .card-input::placeholder { color:#999; }

    .counter {
      position:absolute;
      bottom:24px;
      right:24px;
      background:#fff;
      padding:4px 12px;
      border-radius:999px;
      border:2px solid #000;
      font-size:1.2rem;
      font-weight:700;
      display:none;
    }

    /* Bottom Buttons (Plus/Haus + Stats) */
    .buttons-row {
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      padding:0 16px calc(16px + env(safe-area-inset-bottom));
      height:calc(60px + env(safe-area-inset-bottom));
      background:transparent; /* Karten bleiben dahinter sichtbar */
      display:flex;
      gap:12px;
      z-index:9999;
      pointer-events:none;
    }

    .btn-half {
      flex:1;
      height:60px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.5rem;
      border:none;
      cursor:pointer;
      pointer-events:auto;
    }

    .btn-plus { background:#000; color:#fff; }
    .btn-stats { background:#f3f3f3; border:2px solid #ccc; color:#333; }

    /* Stats View */
    #statsView {
      position:fixed;
      left:0;
      right:0;
      top:100svh;
      bottom:0;
      background:#fff;
      padding:24px;
      padding-bottom:140px;
      overflow-y:auto;
      z-index:50;
    }

    .stats-name { font-size:2rem; font-weight:700; margin-bottom:20px; }
    .stat-bar { width:100%; height:48px; background:#e5e7eb; border-radius:16px; margin-bottom:18px; overflow:hidden; }
    .stat-fill {
      height:100%;
      width:0;
      padding-left:12px;
      display:flex;
      align-items:center;
      font-weight:700;
      border-radius:16px;
      color:#000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Dünner Delete-Balken über der obersten Karte */
    #deletePanel {
      position:fixed;
      left:16px;
      right:16px;
      top:12px; /* wird per JS genauer über der obersten Karte platziert */
      background:#ffffff;
      border-radius:999px;
      box-shadow:0 8px 20px rgba(0,0,0,0.12);
      padding:6px 12px;
      display:none;
      align-items:center;
      justify-content:center;
      gap:8px;
      z-index:10000;
      font-size:12px;
    }

    #deletePanelText {
      font-weight:500;
      white-space:nowrap;
    }

    #deleteAllBtn {
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #d4d4d4;
      background:#f3f3f3;
      color:#ef4444;
      font-weight:600;
      font-size:12px;
      cursor:pointer;
      flex-shrink:0;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginCircle"></div>
  <div id="loginHeadline">Hallo, bitte melde dich an</div>

  <div id="loginButtonBar">
    <button class="btn" id="btnLogin">Login</button>
    <button class="btn" id="btnRegister">Registrieren</button>
  </div>

  <div id="loginForm">
    <input id="loginName" class="login-input" placeholder="Name" type="text" style="display:none;" />
    <input id="loginEmail" class="login-input" placeholder="E-Mail" type="email" />
    <input id="loginPassword" class="login-input" placeholder="Passwort" type="password" />
    <button class="btn" id="loginOkBtn">OK</button>
  </div>

  <div id="loginError"></div>
</div>

<!-- MAIN HABIT PAGE (3 Klötze) -->
<div id="appPage">
  <div class="page">
    <div class="cards">
      <div class="slot" id="slot1"></div>
      <div class="slot" id="slot2"></div>
      <div class="slot" id="slot3"></div>
    </div>
  </div>

  <div class="buttons-row">
    <button class="btn-half btn-plus" id="addBtn" data-mode="main">
      <i data-lucide="plus"></i>
    </button>
    <button class="btn-half btn-stats" id="statsBtn">
      <i data-lucide="bar-chart-2"></i>
    </button>
  </div>

  <div id="statsView"></div>

  <!-- Dünner Shake-Delete-Balken -->
  <div id="deletePanel">
    <span id="deletePanelText">Klicke hier, um alle Habits zu löschen.</span>
    <button id="deleteAllBtn">Löschen</button>
  </div>
</div>

<script>
    lucide.createIcons();

    const supabaseClient = supabase.createClient(
      "https://gglgenarpskajkaanknk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdnbGdlbmFycHNrYWprYWFua25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODA2NzAsImV4cCI6MjA3ODY1NjY3MH0.phVPaPpkiXJ0ncbRiBChpVBtY8gv0sm_MjlCJJnaSt4"
    );

    const loginScreen   = document.getElementById("loginScreen");
    const loginForm     = document.getElementById("loginForm");
    const loginError    = document.getElementById("loginError");
    const appPage       = document.getElementById("appPage");
    const btnLogin      = document.getElementById("btnLogin");
    const btnRegister   = document.getElementById("btnRegister");
    const loginOkBtn    = document.getElementById("loginOkBtn");
    const loginName     = document.getElementById("loginName");
    const loginEmail    = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const addBtnEl      = document.getElementById("addBtn");
    const statsBtnEl    = document.getElementById("statsBtn");
    const statsViewEl   = document.getElementById("statsView");
    const deletePanel   = document.getElementById("deletePanel");
    const deleteAllBtn  = document.getElementById("deleteAllBtn");

    const slotOrder = ["slot3","slot2","slot1"];

    let habits      = [];
    let currentUser = null;
    let authMode    = "login";
    let statsOpen   = false;
    let otherUser   = null;

    let deleteTimeout = null;
    let deletePanelVisible = false;

    const cycleColors = [
      "#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e",
      "#10b981","#14b8a6","#06b6d4","#0ea5e9","#3b82f6","#6366f1",
      "#8b5cf6","#a855f7","#d946ef","#ec4899","#f43f5e","#dc2626",
      "#ea580c","#ca8a04","#4d7c0f","#15803d","#047857","#0f766e",
      "#0369a1","#1d4ed8","#4338ca","#6d28d9","#7e22ce","#be185d"
    ];

    function darken(hex, f=0.55) {
      let r = parseInt(hex.slice(1,3),16)*f|0;
      let g = parseInt(hex.slice(3,5),16)*f|0;
      let b = parseInt(hex.slice(5,7),16)*f|0;
      return `rgb(${r},${g},${b})`;
    }

    function startLoginCircleFloat() {
      if (!document.getElementById("loginCircle")) return;
      gsap.to("#loginCircle", {
        y: -6,
        duration: 2.4,
        repeat: -1,
        yoyo: true,
        ease: "sine.inOut"
      });
    }

    function showAppAfterDataLoaded() {
      appPage.style.display = "block";
      gsap.fromTo(appPage, { opacity:0 }, {
        opacity:1,
        duration:0.5,
        ease:"sine.inOut"
      });

      gsap.to(loginScreen, {
        opacity:0,
        duration:0.45,
        ease:"sine.inOut",
        onComplete: () => { loginScreen.style.display = "none"; }
      });
    }

    // LOGIN UI
    btnLogin.onclick = () => {
      authMode = "login";
      btnLogin.style.display    = "none";
      btnRegister.style.display = "none";
      loginName.style.display   = "none";
      loginForm.style.display   = "flex";
      loginError.style.display  = "none";
    };

    btnRegister.onclick = () => {
      authMode = "register";
      btnLogin.style.display    = "none";
      btnRegister.style.display = "none";
      loginName.style.display   = "block";
      loginForm.style.display   = "flex";
      loginError.style.display  = "none";
    };

    loginOkBtn.onclick = async () => {
      loginError.style.display = "none";
      const email    = loginEmail.value.trim();
      const password = loginPassword.value.trim();
      const name     = loginName.value.trim();

      if (!email || !password || (authMode === "register" && !name)) {
        loginError.textContent = "Bitte alles ausfüllen.";
        loginError.style.display = "block";
        return;
      }

      let error;

      if (authMode === "login") {
        ({ error } = await supabaseClient.auth.signInWithPassword({ email, password }));
      } else {
        const { error: signUpError } = await supabaseClient.auth.signUp({
          email,
          password,
          options: { data: { display_name: name } }
        });
        error = signUpError;
      }

      if (error) {
        loginError.textContent = error.message;
        loginError.style.display = "block";
        return;
      }

      const { data } = await supabaseClient.auth.getUser();
      currentUser = data.user;

      setupRealtime();
      setupShakeDetection();

      await safeLoadHabits();   // ← nur serverseitig laden, ggf. initial anlegen
      showAppAfterDataLoaded();
    };

    // Autologin
    (async () => {
      const { data } = await supabaseClient.auth.getUser();
      if (data.user) {
        currentUser = data.user;
        setupRealtime();
        setupShakeDetection();
        await safeLoadHabits(); // ← nur serverseitig laden, ggf. initial anlegen
        showAppAfterDataLoaded();
      }
    })();

    function setupRealtime() {
      supabaseClient.channel('habits-realtime')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'habits' },
          async () => {
            if (statsOpen) await refreshStatsLive();
          }
        )
        .subscribe();
    }

    // ---------- TEIL 1: Nur-Server-Load + Initialisierung ----------
    async function safeLoadHabits() {
      if (!currentUser) {
        const { data } = await supabaseClient.auth.getUser();
        currentUser = data.user;
        if (!currentUser) return;
      }

      const { data, error } = await supabaseClient
        .from("habits_active")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("inserted_at", { ascending: true })
        .limit(3);

      if (error) {
        console.error("safeLoadHabits error:", error);
        return;
      }

      const rows = data || [];

      if (rows.length === 0) {
        await createInitialHabits();   // exakt 3 in DB anlegen
        return safeLoadHabits();       // danach erneut laden
      }

      habits = rows;

      clearAllSlots();
      const baseDelay = 0.0;
      habits.forEach((habit, i) => {
        const delay = baseDelay + (habits.length - 1 - i) * 0.12;
        createCardFromHabit(habit, i, delay);
      });

      refreshAddButtonIcon();
    }

    async function createInitialHabits() {
      if (!currentUser) return;

      const inserts = Array.from({ length: 3 }).map(() => ({
        user_id: currentUser.id,
        title: "",
        color: "#e4e4e4",
        progress: 0,
        goal: 1,
        appear_once: false
      }));

      const { error } = await supabaseClient.from("habits").insert(inserts);
      if (error) console.error("createInitialHabits error:", error);
    }

    function clearAllSlots() {
      slotOrder.forEach(id => { document.getElementById(id).innerHTML = ""; });
    }

    function refreshAddButtonIcon() {
      const addBtn = addBtnEl;

      if (addBtn.dataset.mode === "stats") {
        addBtn.innerHTML = '<i data-lucide="house"></i>';
        addBtn.classList.remove("btn-plus");
        addBtn.style.background = "#f3f3f3";
        addBtn.style.color      = "#333";
        addBtn.style.border     = "2px solid #ccc";
        lucide.createIcons();
        return;
      }

      if (habits.length < 3) {
        addBtn.innerHTML = '<i data-lucide="plus"></i>';
        addBtn.classList.add("btn-plus");
        addBtn.style.background = "#000";
        addBtn.style.color      = "#fff";
        addBtn.style.border     = "none";
      } else {
        addBtn.innerHTML = '<i data-lucide="home"></i>';
        addBtn.classList.remove("btn-plus");
        addBtn.style.background = "#f3f3f3";
        addBtn.style.color      = "#333";
        addBtn.style.border     = "2px solid #ccc";
      }
      lucide.createIcons();
    }

    function createCardFromHabit(habit, index, delay=0) {
      const slot = document.getElementById(slotOrder[index]);
      const card = document.createElement("div");
      card.className = "card";

      const rawGoal  = habit.goal;
      const goal     = (rawGoal === null || rawGoal === undefined) ? 1 : rawGoal;
      const progress = habit.progress || 0;
      const dbColor  = habit.color || "#e4e4e4";

      card.dataset.index    = index;
      card.dataset.habitId  = habit.id;
      card.dataset.goal     = goal;
      card.dataset.progress = progress;
      card.dataset.color    = dbColor;

      const isActive = progress > 0;
      card.dataset.active = isActive ? "true" : "false";

      card.innerHTML = `
        <div class="card-face front">
          <input class="card-input" placeholder="Titel eingeben..." />
          <div class="counter"></div>
        </div>
        <div class="card-face back">
          <div class="half" id="gpsArea">
            <i data-lucide="map-pin" style="width:32px;height:32px;color:#777;"></i>
          </div>
          <div class="half" id="numArea">0</div>
        </div>
      `;

      slot.appendChild(card);
      lucide.createIcons();

      const input   = card.querySelector(".card-input");
      const counter = card.querySelector(".counter");
      const gpsArea = card.querySelector("#gpsArea");
      const numArea = card.querySelector("#numArea");

      input.value = habit.title || "";

      numArea.textContent = goal;
      if (goal >= 2) {
        counter.style.display = "block";
        counter.textContent   = progress + "/" + goal;
      } else {
        counter.style.display = "none";
      }

      if (isActive) {
        card.style.background = dbColor;
        input.style.color     = darken(dbColor);
      } else {
        card.style.background = "#e4e4e4";
        card.dataset.color    = "#e4e4e4";
        input.style.color     = "#666";
      }

      gsap.fromTo(card, { y:-80, opacity:0 }, {
        y:0,
        opacity:1,
        duration:0.6,
        ease:"power1.out",
        delay
      });

      attachCardLogic(card);
    }

    function attachCardLogic(card) {
      const input   = card.querySelector(".card-input");
      const counter = card.querySelector(".counter");
      const gpsArea = card.querySelector("#gpsArea");
      const numArea = card.querySelector("#numArea");

      let swipeStartX = 0;
      let swipeEndX   = 0;

      card.addEventListener("touchstart",(e)=>{
        swipeStartX = e.touches[0].clientX;
        swipeEndX   = swipeStartX;
      });

      card.addEventListener("touchmove",(e)=>{
        swipeEndX = e.touches[0].clientX;
      });

      card.addEventListener("touchend",()=>{
        const dx = swipeEndX - swipeStartX;

        if (dx < -40 && !card.style.transform.includes("180deg")){
          gsap.to(card,{ rotationY:180, duration:0.48, ease:"sine.inOut" });
        }
        if (dx > 40 && card.style.transform.includes("180deg")){
          gsap.to(card,{ rotationY:0, duration:0.48, ease:"sine.inOut" });
        }
      });

      numArea.addEventListener("click",(e)=>{
        e.stopPropagation();
        let y = parseInt(card.dataset.goal) || 0;
        y = (y + 1) % 8;
        card.dataset.goal = y;
        numArea.textContent = y;

        let x = parseInt(card.dataset.progress) || 0;
        if (x > y) {
          x = y;
          card.dataset.progress = x;
        }

        if (y >= 2) {
          counter.style.display = "block";
          counter.textContent   = x + "/" + y;
        } else {
          counter.style.display = "none";
        }

        saveHabit(card);
      });

      gpsArea.addEventListener("click",(e)=>{
        e.stopPropagation();
        gsap.to(card,{rotationY:0,duration:0.45,ease:"sine.inOut"});
      });

      // Long-Press-Farbwechsel (DB-Save nur am Ende)
      let pressTimer = null;
      let pressInterval = null;
      let lastColor = null;

      card.addEventListener("touchstart",()=>{
        clearTimeout(pressTimer);
        clearInterval(pressInterval);
        lastColor = null;

        pressTimer = setTimeout(()=>{
          if (card.dataset.active === "true") {
            let i = 0;
            pressInterval = setInterval(()=>{
              const col = cycleColors[i % cycleColors.length];
              card.style.background = col;
              card.dataset.color    = col;
              input.style.color     = darken(col);
              lastColor = col;
              i++;
            },900);
          }
        },300);
      });

      card.addEventListener("touchend",()=>{
        clearTimeout(pressTimer);
        clearInterval(pressInterval);
        if (lastColor) saveHabit(card);
      });

      input.addEventListener("blur", ()=> { saveHabit(card); });
      input.addEventListener("keydown", (e)=>{
        if(e.key==="Enter"){ e.preventDefault(); input.blur(); }
      });

      card.addEventListener("click",()=>{
        if(!input.value.trim()) return;

        let goal     = parseInt(card.dataset.goal) || 0;
        let progress = parseInt(card.dataset.progress) || 0;
        let active   = card.dataset.active === "true";
        const idx    = parseInt(card.dataset.index);

        if (goal <= 1) {
          if (active) {
            active   = false;
            progress = 0;
            card.style.background = "#e4e4e4";
            card.dataset.color    = "#e4e4e4";
            input.style.color     = "#666";
          } else {
            active   = true;
            progress = 1;

            let col = card.dataset.color;
            if (!col || col === "#e4e4e4") col = cycleColors[idx % cycleColors.length];

            card.style.background = col;
            card.dataset.color    = col;
            input.style.color     = darken(col);
          }
        } else {
          if (progress < goal) {
            progress += 1;
            active = true;

            let col = card.dataset.color;
            if (!col || col === "#e4e4e4") col = cycleColors[idx % cycleColors.length];

            card.style.background = col;
            card.dataset.color    = col;
            input.style.color     = darken(col);
          } else {
            return;
          }
        }

        card.dataset.progress = progress;
        card.dataset.active   = active ? "true" : "false";

        if (goal >= 2) {
          counter.style.display = "block";
          counter.textContent   = progress + "/" + goal;
        } else {
          counter.style.display = "none";
        }

        saveHabit(card);
      });
    }

    async function saveHabit(card) {
      if (!currentUser) return;

      const habitId = card.dataset.habitId;
      const input   = card.querySelector(".card-input");
      const title   = input.value.trim();
      const color   = card.dataset.color || "#e4e4e4";
      const progress = parseInt(card.dataset.progress) || 0;
      const goal     = parseInt(card.dataset.goal)     || 0;

      if (!habitId) return;

      const { error } = await supabaseClient
        .from("habits")
        .update({ title, color, progress, goal })
        .eq("id", habitId);

      if (error) console.error("saveHabit error:", error);
    }

    // Add-Button: erstellt nur DB-Datensatz, niemals lokal
    addBtnEl.addEventListener("click", async () => {
      if (addBtnEl.dataset.mode === "stats") {
        addBtnEl.dataset.mode = "main";
        statsOpen = false;
        gsap.to("#statsView",{top:"100svh",duration:0.42,ease:"power1.in"});
        refreshAddButtonIcon();
        return;
      }

      if (habits.length >= 3) return;

      if (!currentUser) {
        const { data } = await supabaseClient.auth.getUser();
        currentUser = data.user;
        if (!currentUser) return;
      }

      const { data, error } = await supabaseClient
        .from("habits")
        .insert({
          user_id: currentUser.id,
          title: "",
          color: "#e4e4e4",
          progress: 0,
          goal: 1,
          appear_once: false
        })
        .select()
        .single();

      if (error) {
        console.error("insert habit error:", error);
        return;
      }

      habits.push(data);
      const index = habits.length - 1;
      createCardFromHabit(data, index, 0);
      refreshAddButtonIcon();
    });

  async function loadOtherUser() {
    if (!currentUser) return null;

    const { data, error } = await supabaseClient
      .from("users_public")
      .select("id, display_name")
      .neq("id", currentUser.id)
      .limit(1);

    if (error) {
      console.error("loadOtherUser error:", error);
      return null;
    }

    return data && data.length > 0 ? data[0] : null;
  }

  async function loadHabitsForUser(userId) {
    const { data, error } = await supabaseClient
      .from("habits_active")
      .select("*")
      .eq("user_id", userId)
      .order("inserted_at", { ascending: true })
      .limit(3);

    if (error) {
      console.error("loadHabitsForUser error:", error);
      return [];
    }
    return data || [];
  }
  
  function barsHtml(habits) {
    let html = "";
    for (let i = 0; i < 3; i++) {
      const h = habits[i];

      if (!h) {
        html += `
          <div class="stat-bar" style="position:relative;">
            <div class="stat-fill" style="width:0%"></div>
          </div>`;
        continue;
      }

      const x = h.progress || 0;
      const y = h.goal     || 0;
      const rawTitle = h.title || "";
      const hasTitle = rawTitle.trim().length > 0;
      const color = h.color || "#e5e7eb";

      let percent = 0;
      if (y > 0) {
        percent = (y === 1)
          ? (x >= 1 ? 100 : 0)
          : Math.round((x / y) * 100);
      }

      html += `
        <div class="stat-bar" style="position:relative;">

          <!-- Fortschrittsbalken -->
          <div style="
            position:absolute;
            inset:0;
            width:${percent}%;
            background:${color};
            border-radius:16px;
            z-index:1;
          "></div>

          <!-- Text nur wenn vorhanden -->
          <div style="
            position:relative;
            z-index:2;
            height:100%;
            display:flex;
            align-items:center;
            padding-left:12px;
            font-weight:700;
            color:#000;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
          ">
            ${hasTitle ? rawTitle : ""}
          </div>

        </div>
      `;
    }

    return html;
  }
    
    async function loadStreakForUser(userId) {
      const { data, error } = await supabaseClient
        .from("streaks")
        .select("current_streak")
        .eq("user_id", userId)
        .single();

      if (error || !data) {
        return 0;
      }

      return data.current_streak || 0;
    }

    async function renderStats(myHabits, otherHabits, otherUserData) {
      const myName = (
        currentUser?.user_metadata?.display_name ||
        currentUser?.email?.split("@")[0] ||
        "Du"
      );

      const myStreak = await loadStreakForUser(currentUser.id);

      let html = "";

      // === Mein Name + Streak rechts perfekt bündig ===
      html += `
        <div style="
          display:flex;
          justify-content:space-between;
          align-items:flex-end;
          margin-bottom:20px;
        ">

          <!-- Name: klickbar / editierbar -->
          <div id="editableNameWrapper" style="display:flex; align-items:flex-end; gap:6px;">
            <div id="editableName" class="stats-name" style="line-height:1; margin:0; padding:0; cursor:pointer;">
              ${myName}
            </div>
          </div>

          <!-- Streak -->
          <div style="
            display:flex;
            align-items:flex-end;
            gap:6px;
            font-size:1.5rem;
            font-weight:700;
            line-height:1;
          ">
            <i data-lucide="medal" style="width:22px; height:22px;"></i>
            <span>${myStreak}</span>
          </div>

        </div>
      `;

      html += barsHtml(myHabits);

      // === Optional: anderer User ===
      if (otherUserData) {
        const otherName = otherUserData.display_name || "Freund:in";
        const otherStreak = await loadStreakForUser(otherUserData.id);

        html += `<div style="height:40px"></div>`;

        html += `
          <div style="
            display:flex;
            justify-content:space-between;
            align-items:flex-end;
            margin-bottom:20px;
          ">
            <div class="stats-name" style="
              line-height:1;
              margin:0;
              padding:0;
            ">${otherName}</div>

            <div style="
              display:flex;
              align-items:flex-end;
              gap:6px;
              font-size:1.5rem;
              font-weight:700;
              line-height:1;
            ">
              <i data-lucide="medal" style="width:22px; height:22px;"></i>
              <span>${otherStreak}</span>
            </div>
          </div>
        `;

        html += barsHtml(otherHabits);
      }

      statsViewEl.innerHTML = html;
      lucide.createIcons();
    }

  async function refreshStatsLive() {
    if (!currentUser) return;

    const myHabits    = await loadHabitsForUser(currentUser.id);
    const otherHabits = otherUser ? await loadHabitsForUser(otherUser.id) : [];
    renderStats(myHabits, otherHabits, otherUser);
  }

  statsBtnEl.addEventListener("click", async () => {
    if (!currentUser) return;

    otherUser = await loadOtherUser();
    const [myHabits, otherHabits] = await Promise.all([
      loadHabitsForUser(currentUser.id),
      otherUser ? loadHabitsForUser(otherUser.id) : Promise.resolve([])
    ]);

    renderStats(myHabits, otherHabits, otherUser);

    statsOpen = true;
    addBtnEl.dataset.mode = "stats";
    refreshAddButtonIcon();
    gsap.to("#statsView",{top:0,duration:0.45,ease:"power1.out"});
  });

  // === Shake Detection + UNO-Wiggle/Hide ===

  let lastShakeTime = 0;
  const SHAKE_THRESHOLD = 18; // ggf. anpassen

  function setupShakeDetection() {
    if (typeof window === "undefined") return;
    if (!("DeviceMotionEvent" in window)) return;

    if (typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function") {
      document.body.addEventListener("click", function reqOnce() {
        DeviceMotionEvent.requestPermission().catch(()=>{}).finally(()=>{
          document.body.removeEventListener("click", reqOnce);
        });
      });
    }

    window.addEventListener("devicemotion", handleDeviceMotion, false);
  }

  function handleDeviceMotion(event) {
    const acc = event.accelerationIncludingGravity || event.acceleration;
    if (!acc) return;

    const x = acc.x || 0;
    const y = acc.y || 0;
    const z = acc.z || 0;
    const magnitude = Math.sqrt(x*x + y*y + z*z);

    const now = Date.now();
    if (magnitude > SHAKE_THRESHOLD && now - lastShakeTime > 1200) {
      lastShakeTime = now;
      onShakeDetected();
    }
  }

  function onShakeDetected() {
    if (!habits || habits.length === 0) return;
    if (deletePanelVisible) return;

    showDeletePanelAndAnimateCards();
  }

  function showDeletePanelAndAnimateCards() {
    deletePanelVisible = true;
    clearTimeout(deleteTimeout);

    const cards = document.querySelectorAll(".card");
    const buttonsRow = document.querySelector(".buttons-row");
    if (!buttonsRow || cards.length === 0) return;

    const buttonsRect = buttonsRow.getBoundingClientRect();
    let panelTopBase = null;

    cards.forEach((card, idx) => {
      const rect = card.getBoundingClientRect();
      const targetTop = buttonsRect.top - rect.height / 2; // Karte halb hinter Buttons
      const dy = targetTop - rect.top;

      if (idx === 0) {
        panelTopBase = targetTop;
      }

      const tl = gsap.timeline();
      tl.to(card, { rotation:-2, duration:0.08, ease:"power1.out" })
        .to(card, { rotation:2, repeat:4, yoyo:true, duration:0.08, ease:"sine.inOut" })
        .to(card, { rotation:0, y:dy, duration:0.38, ease:"power2.out" }, "-=0.08");
    });

    // Panel anzeigen und direkt oberhalb der obersten Karte positionieren
    deletePanel.style.display = "flex";
    deletePanel.style.opacity = "0";

    requestAnimationFrame(() => {
      const panelHeight = deletePanel.offsetHeight || 24;
      let panelTop = 12;
      if (panelTopBase !== null) {
        panelTop = panelTopBase - panelHeight - 8;
        if (panelTop < 8) panelTop = 8;
      }
      deletePanel.style.top = panelTop + "px";

      gsap.to(deletePanel, {
        opacity:1,
        y:0,
        duration:0.25,
        ease:"power1.out"
      });
    });

    // nach 5 Sekunden Inaktivität wieder zurück animieren (ohne Löschen)
    deleteTimeout = setTimeout(() => {
      reverseShakeAnimation();
    }, 5000);
  }

  function reverseShakeAnimation() {
    if (!deletePanelVisible) return;
    deletePanelVisible = false;
    clearTimeout(deleteTimeout);

    const cards = document.querySelectorAll(".card");

    cards.forEach(card => {
      const tl = gsap.timeline();
      tl.to(card, {
          y: "-10",
          rotation: -2,
          duration: 0.12,
          ease: "power1.out"
        })
        .to(card, {
          y: 0,
          rotation: 0,
          duration: 0.28,
          ease: "power2.inOut"
        });
    });

    gsap.to(deletePanel, {
      opacity:0,
      y:4,
      duration:0.22,
      ease:"power1.in",
      onComplete: () => {
        deletePanel.style.display = "none";
        deletePanel.style.y = 0;
      }
    });
  }

  async function deleteAllHabits() {
    clearTimeout(deleteTimeout);

    if (currentUser && habits && habits.length > 0) {
      const ids = habits.map(h => h.id);
      const { error } = await supabaseClient
        .from("habits")
        .delete()
        .in("id", ids);

      if (error) {
        console.error("deleteAllHabits error:", error);
      }
    }

    habits = [];
    clearAllSlots();
    refreshAddButtonIcon();
    reverseShakeAnimation();
  }

  deleteAllBtn.addEventListener("click", () => {
    deleteAllHabits();
  });

  deletePanel.addEventListener("click", () => {
    // Optional: hier könnte man das Timeout abbrechen etc.
  });

  // Login-Kreis schwebend animieren
  startLoginCircleFloat();

  /*
    SQL zum Sicherstellen, dass die Spalte "color" existiert:

    ALTER TABLE public.habits
    ADD COLUMN IF NOT EXISTS color text DEFAULT '#e4e4e4';

    Aktiv-Status wird logisch abgeleitet über:
      progress > 0  => aktiv
      progress = 0  => inaktiv
  */
    
    async function requestAllPermissions() {
      // Notifications
      if (Notification.permission !== "granted") {
        await Notification.requestPermission();
      }

      // Motion
      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        await DeviceMotionEvent.requestPermission().catch(()=>{});
      }

      // Geo
      navigator.geolocation.getCurrentPosition(()=>{}, ()=>{}, {
        enableHighAccuracy: true
      });
    }

    requestAllPermissions();
    
    async function subscribeUserToPush() {
      const reg = await navigator.serviceWorker.ready;

      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: "<VAPID_PUBLIC_KEY>"
      });

      const { error } = await supabaseClient
        .from("push_subscriptions")
        .insert({
          user_id: currentUser.id,
          endpoint: sub.endpoint,
          p256dh: btoa(String.fromCharCode(...new Uint8Array(sub.getKey("p256dh")))),
          auth: btoa(String.fromCharCode(...new Uint8Array(sub.getKey("auth"))))
        });

      if (error) console.error("push subscribe error", error);
    }
    
    (async () => {
       await requestAllPermissions();
       await subscribeUserToPush();
    })();
</script>
</body>
</html>
  
