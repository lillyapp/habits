<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Habit App</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --black:#000;
      --white:#fff;
      --gray:#e5e5e5;
      --p1:#FFE8A3;
      --p2:#CFFFD8;
      --p3:#D6E5FF;
      --p4:#FFD6E8;
      --p5:#E9DAFF;
      --p6:#FFF2C7;
    }

    body {
      margin:0;
      background:var(--white);
      color:var(--black);
      font-family:system-ui,-apple-system,sans-serif;
      height:100vh;
      overflow:hidden;
      position:relative;
    }

    /* Screens */
    .screen {
      display:none;
      position:absolute;
      inset:0;
    }
    .active { display:flex; }

    /* Login */
    #loginScreen {
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }

    @keyframes pulse {0%{transform:scale(1);}50%{transform:scale(1.06);}100%{transform:scale(1);}}

    #loginCircle {
      width:30px;height:30px;background:#000;border-radius:50%;
      animation:pulse 2.2s ease-in-out infinite;
    }

    #loginHeadline {
      margin-top:28px;font-size:26px;font-weight:600;
      text-align:center;padding:0 20px;max-width:240px;
    }

    #loginButtonBar {
      position:absolute;bottom:24px;width:100%;display:flex;
      gap:14px;padding:0 20px;transition:bottom .25s ease;
    }

    .btn {
      flex:1;padding:14px;border:none;border-radius:20px;font-size:17px;
    }

    #btnLogin {background:#000;color:#fff;}
    #btnRegister {background:#e5e5e5;}

    #loginForm {
      display:none;flex-direction:column;gap:12px;padding:20px;
      width:100%;max-width:500px;box-sizing:border-box;
    }

    .login-input {
      padding:12px;border:none;border-radius:12px;
      background:#e5e5e5;font-size:16px;
    }

    /* Main */
    #mainScreen {
      flex-direction:column;
      padding:20px;padding-bottom:120px;
      box-sizing:border-box;overflow-y:auto;
    }

    #topStatsBox {
      width:calc(100% - 40px);
      max-width:600px;background:#e5e5e5;
      margin:0 auto 20px;padding:16px;
      border-radius:18px;
    }

    .progress {width:100%;height:12px;background:#f2f2f2;border-radius:6px;overflow:hidden;}
    .progress-inner {width:0;height:100%;background:#000;transition:width .35s ease;
    }
      #habitList {
  width: calc(100% - 40px);
  max-width: 600px;
  margin: 0 auto;

  display: grid;

  /* genau 3 Elemente pro Reihe */
  grid-template-columns: repeat(3, 100px);

  grid-auto-rows: 100px;
  gap: 16px;

  justify-content: center; /* zentriert das gesamte Grid */
  justify-items: center;
  align-items: center;
}

    .habitCard {
      position:relative;
      width:100px;height:100px;
      border:3px solid #000;border-radius:20px;
      box-shadow:0 6px 14px rgba(0,0,0,0.12);
      background:#fff;
      display:flex;justify-content:center;
      align-items:center;text-align:center;
      font-size:15px;font-weight:600;
      user-select:none;
      transition:transform .25s ease, opacity .25s ease;
    }

    .habitInput {
      width:80%;border:none;border-radius:10px;
      padding:6px;font-size:14px;text-align:center;
    }

    .dragging {
      opacity:0.6;
      transform:scale(1.06);
      z-index:50;
    }

    #bottomActionBar {
      position:fixed;bottom:20px;left:50%;
      transform:translateX(-50%);
      width:calc(100% - 40px);max-width:600px;
      background:#000;color:#fff;border-radius:18px;
      padding:10px 14px;font-size:26px;font-weight:600;
      display:flex;justify-content:center;align-items:center;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="screen active">
  <div id="loginCircle"></div>
  <div id="loginHeadline">Hallo, bitte melde dich an</div>

  <div id="loginButtonBar">
    <button id="btnLogin" class="btn">Login</button>
    <button id="btnRegister" class="btn">Registrieren</button>
  </div>

  <div id="loginForm">
    <input id="loginEmail" type="email" placeholder="E-Mail" class="login-input">
    <input id="loginPassword" type="password" placeholder="Passwort" class="login-input">
    <button id="loginOkBtn" class="btn" style="background:#000;color:#fff;">OK</button>
  </div>
</div>

<!-- MAIN -->
<div id="mainScreen" class="screen">
  <div id="topStatsBox">
    <div class="progress"><div class="progress-inner" id="progressInner"></div></div>
  </div>

  <div id="habitList"></div>
</div>

<div id="bottomActionBar">+</div>

<script>
/* -------------------------- */
/* Supabase */
/* -------------------------- */
const supabaseClient = supabase.createClient(
  "https://gglgenarpskajkaanknk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdnbGdlbmFycHNrYWprYWFua25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODA2NzAsImV4cCI6MjA3ODY1NjY3MH0.phVPaPpkiXJ0ncbRiBChpVBtY8gv0sm_MjlCJJnaSt4"
);

/* LOGIN */
btnLogin.onclick=()=>{
  loginForm.style.display="flex";
  loginForm.dataset.mode="login";
  loginButtonBar.style.bottom="260px";
};
btnRegister.onclick=()=>{
  loginForm.style.display="flex";
  loginForm.dataset.mode="register";
  loginButtonBar.style.bottom="260px";
};

loginOkBtn.onclick=async()=>{
  const email=loginEmail.value;
  const pw=loginPassword.value;
  const mode=loginForm.dataset.mode;

  if(mode==="login"){
    const {error}=await supabaseClient.auth.signInWithPassword({email,password:pw});
    if(!error){
      loginScreen.classList.remove("active");
      mainScreen.classList.add("active");
      loadHabits();
    }
  } else {
    await supabaseClient.auth.signUp({email,password:pw});
  }
};

/* -------------------------- */
/* GRID SYSTEM */
/* -------------------------- */

const habitList=document.getElementById("habitList");

async function loadHabits(){
  const user=(await supabaseClient.auth.getUser()).data.user;

  const {data}=await supabaseClient
    .from("habits")
    .select("*")
    .eq("user_id",user.id)
    .order("index", { ascending:true });

  updateProgress(data);

  habitList.innerHTML="";

  data.filter(h=>h.zustand!=="erledigt").forEach(h=>{
    const card=createHabitCard(h);
    habitList.appendChild(card);
  });
}

function createHabitCard(habit){
  const card=document.createElement("div");
  card.className="habitCard";
  card.dataset.id=habit.id;
  card.dataset.index=habit.index ?? 999999;
  card.style.background=randomPastel();
  card.textContent=habit.titel;

  card.addEventListener("pointerdown", e => startDrag(e, card));
  card.addEventListener("dblclick", ()=>editHabit(card));

  return card;
}

function randomPastel(){
  const arr=["var(--p1)","var(--p2)","var(--p3)","var(--p4)","var(--p5)","var(--p6)"];
  return arr[Math.floor(Math.random()*arr.length)];
}

/* EDIT inline */
function editHabit(card){
  const old=card.textContent;
  card.innerHTML=`<input class="habitInput" value="${old}">`;
  const input=card.querySelector(".habitInput");
  input.focus();

  input.onblur=()=>saveEdit(card,input.value);
  input.onkeydown=e=>{if(e.key==="Enter")saveEdit(card,input.value)};
}

async function saveEdit(card,newVal){
  card.textContent=newVal;

  await supabaseClient
    .from("habits")
    .update({titel:newVal})
    .eq("id",card.dataset.id);
}

/* -------------------------- */
/* ADD NEW Habit Inline */
/* -------------------------- */
bottomActionBar.onclick=()=>{
  const card=document.createElement("div");
  card.className="habitCard";
  card.style.background=randomPastel();
  card.innerHTML=`<input class="habitInput" placeholder="Titel">`;

  habitList.appendChild(card);
  const input=card.querySelector("input");
  input.focus();

  input.onblur=()=>saveNewHabit(input.value, card);
  input.onkeydown=e=>{
    if(e.key==="Enter")saveNewHabit(input.value, card);
  };
};

async function saveNewHabit(title, card){
  if(!title.trim()){
    card.remove();
    return;
  }

  const user=(await supabaseClient.auth.getUser()).data.user;

  const {data:existing}=await supabaseClient
    .from("habits")
    .select("index")
    .eq("user_id", user.id);

  const nextIndex = existing.length;

  const {data}=await supabaseClient
    .from("habits")
    .insert({
      user_id:user.id,
      titel:title,
      zustand:"offen",
      index:nextIndex
    })
    .select()
    .single();

  card.dataset.id=data.id;
  card.dataset.index=data.index;
  card.textContent=data.titel;

  card.addEventListener("pointerdown", e => startDrag(e, card));
  card.addEventListener("dblclick", ()=>editHabit(card));
}

/* -------------------------- */
/* DRAG & SORT */
/* -------------------------- */

let dragCard=null;
let startIndex=null;
let ghost=null;

function startDrag(e, card){
  dragCard=card;
  startIndex=parseInt(card.dataset.index);

  card.setPointerCapture(e.pointerId);
  card.classList.add("dragging");

  card.addEventListener("pointermove", moveDrag);
  card.addEventListener("pointerup", endDrag);
}

function moveDrag(e){
  const card=dragCard;
  const rect=card.getBoundingClientRect();

  card.style.transform=`translate(${e.clientX-rect.width/2 - rect.left}px, ${e.clientY-rect.height/2 - rect.top}px)`;

  const cards=[...habitList.children].filter(c=>c!==dragCard);

  const nearest=cards.find(c=>isPointerInside(e,c));
  if(nearest){
    reorder(dragCard,nearest);
  }
}

function endDrag(e){
  const card=dragCard;

  card.classList.remove("dragging");
  card.style.transform="";

  card.removeEventListener("pointermove", moveDrag);
  card.removeEventListener("pointerup", endDrag);
  card.releasePointerCapture(e.pointerId);

  dragCard=null;
}

function isPointerInside(e, card){
  const r=card.getBoundingClientRect();
  return (
    e.clientX>r.left &&
    e.clientX<r.right &&
    e.clientY>r.top &&
    e.clientY<r.bottom
  );
}

function reorder(dragged, target){
  const draggedIndex=parseInt(dragged.dataset.index);
  const targetIndex=parseInt(target.dataset.index);

  if(draggedIndex===targetIndex) return;

  const all=[...habitList.children];
  all.sort((a,b)=>parseInt(a.dataset.index)-parseInt(b.dataset.index));

  all.splice(draggedIndex,1);
  all.splice(targetIndex,0,dragged);

  all.forEach((c,i)=>{
    c.dataset.index=i;
    habitList.appendChild(c);
  });

  saveOrder(all);
}

async function saveOrder(all){
  for(const c of all){
    await supabaseClient
      .from("habits")
      .update({index:parseInt(c.dataset.index)})
      .eq("id",c.dataset.id);
  }
}

/* Progress */
function updateProgress(list){
  const done=list.filter(x=>x.zustand==="erledigt").length;
  const total=list.length;
  const pct=total?(done/total)*100:0;
  progressInner.style.width=pct+"%";
}
</script>
</body>
</html