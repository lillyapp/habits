<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Consistency</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/lillyapp/habits/refs/heads/main/3FC2E555-7142-43BE-83DE-E5ED7A123793.png">

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <style>
    :root {
      --page-padding: 16px;
      --card-height: calc((100svh - 16px*5 - 60px - env(safe-area-inset-bottom)) / 3);
    }

    * {
      margin:0;
      padding:0;
      box-sizing:border-box;
      user-select:none;
      -webkit-user-select:none;
    }

    body {
      margin:0;
      padding:0;
      font-family: "Poppins", sans-serif;
      background:#fff;
      color:#000;
      height:100svh;
      overflow:hidden;
    }

    /* LOGIN */
    #loginScreen {
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      padding:20px;
      z-index:20;
      background:#fff;
      opacity:1;
      transition:opacity 0.4s ease;
    }

    @keyframes pulse {
      0% {transform:scale(1);}
      50%{transform:scale(1.06);}
      100%{transform:scale(1);}
    }

    #loginCircle {
      width:30px;
      height:30px;
      background:#000;
      border-radius:50%;
      animation:pulse 2.2s ease-in-out infinite;
    }

    #loginHeadline {
      margin-top:28px;
      font-size:26px;
      font-weight:600;
      text-align:center;
    }

    #loginButtonBar {
      width:100%;
      max-width:400px;
      display:flex;
      gap:14px;
      margin-top:50px;
    }

    .btn {
      flex:1;
      padding:14px;
      border-radius:20px;
      border:none;
      font-size:17px;
      cursor:pointer;
    }

    #btnLogin    {background:#000; color:#fff;}
    #btnRegister {background:#e5e5e5; color:#000;}

    #loginForm {
      width:100%;
      max-width:400px;
      display:none;
      flex-direction:column;
      gap:12px;
      margin-top:30px;
    }

    .login-input {
      padding:12px;
      border:none;
      border-radius:12px;
      background:#e5e5e5;
    }

    #loginError {
      margin-top:12px;
      color:#ef4444;
      font-size:14px;
      display:none;
      text-align:center;
    }

    /* MAIN PAGE (Habit-Klötze) */
    #appPage {
      position:absolute;
      inset:0;
      display:none;
      opacity:0;
    }

    .page {
      height:100%;
      display:flex;
      flex-direction:column;
      padding:16px;
      padding-bottom:140px;
      gap:16px;
    }

    .cards {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .slot {
      position:relative;
      height:var(--card-height);
      perspective:1200px;
    }

    .card {
      position:absolute;
      inset:0;
      border-radius:24px;
      background:#e4e4e4;
      padding:24px;
      transform-style:preserve-3d;
      cursor:pointer;
      opacity:0;
      transition:transform 0.25s linear;
    }

    .card-face {
      position:absolute;
      inset:0;
      backface-visibility:hidden;
      border-radius:24px;
      padding:24px;
    }

    .front { background:transparent; }

    .back {
      background:#e4e4e4;
      transform:rotateY(180deg);
      display:flex;
      flex-direction:row;
      justify-content:space-between;
      padding:24px;
    }

    .half {
      width:50%;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:2rem;
      font-weight:800;
      color:#777;
    }

    .card-input {
      position:absolute;
      bottom:24px;
      left:24px;
      width:60%;
      font-size:2rem;
      font-weight:800;
      border:none;
      background:transparent;
      outline:none;
      color:#666;
    }

    .card-input::placeholder { color:#999; }

    .counter {
      position:absolute;
      bottom:24px;
      right:24px;
      background:#fff;
      padding:4px 12px;
      border-radius:999px;
      border:2px solid #000;
      font-size:1.2rem;
      font-weight:700;
      display:none;
    }

    /* Bottom Buttons (Plus/Haus + Stats) */
    .buttons-row {
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      padding:0 16px calc(16px + env(safe-area-inset-bottom));
      height:calc(60px + env(safe-area-inset-bottom));
      background:transparent; /* Karten bleiben dahinter sichtbar */
      display:flex;
      gap:12px;
      z-index:9999;
      pointer-events:none;
    }

    .btn-half {
      flex:1;
      height:60px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.5rem;
      border:none;
      cursor:pointer;
      pointer-events:auto;
    }

    .btn-plus { background:#000; color:#fff; }
    .btn-stats { background:#f3f3f3; border:2px solid #ccc; color:#333; }

    /* Stats View */
    #statsView {
      position:fixed;
      left:0;
      right:0;
      top:100svh;
      bottom:0;
      background:#fff;
      padding:24px;
      padding-bottom:140px;
      overflow-y:auto;
      z-index:50;
    }

    .stats-name { font-size:2rem; font-weight:700; margin-bottom:20px; }
    .stat-bar { width:100%; height:48px; background:#e5e7eb; border-radius:16px; margin-bottom:18px; overflow:hidden; }
    .stat-fill {
      height:100%;
      width:0;
      padding-left:12px;
      display:flex;
      align-items:center;
      font-weight:700;
      border-radius:16px;
      color:#000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Dünner Delete-Balken über der obersten Karte */
    #deletePanel {
      position:fixed;
      left:16px;
      right:16px;
      top:12px; /* wird per JS genauer über der obersten Karte platziert */
      background:#ffffff;
      border-radius:999px;
      box-shadow:0 8px 20px rgba(0,0,0,0.12);
      padding:6px 12px;
      display:none;
      align-items:center;
      justify-content:center;
      gap:8px;
      z-index:10000;
      font-size:12px;
    }

    #deletePanelText {
      font-weight:500;
      white-space:nowrap;
    }

    #deleteAllBtn {
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #d4d4d4;
      background:#f3f3f3;
      color:#ef4444;
      font-weight:600;
      font-size:12px;
      cursor:pointer;
      flex-shrink:0;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginCircle"></div>
  <div id="loginHeadline">Hallo, bitte melde dich an</div>

  <div id="loginButtonBar">
    <button class="btn" id="btnLogin">Login</button>
    <button class="btn" id="btnRegister">Registrieren</button>
  </div>

  <div id="loginForm">
    <input id="loginName" class="login-input" placeholder="Name" type="text" style="display:none;" />
    <input id="loginEmail" class="login-input" placeholder="E-Mail" type="email" />
    <input id="loginPassword" class="login-input" placeholder="Passwort" type="password" />
    <button class="btn" id="loginOkBtn">OK</button>
  </div>

  <div id="loginError"></div>
</div>

<!-- MAIN HABIT PAGE (3 Klötze) -->
<div id="appPage">
  <div class="page">
    <div class="cards">
      <div class="slot" id="slot1"></div>
      <div class="slot" id="slot2"></div>
      <div class="slot" id="slot3"></div>
    </div>
  </div>

  <div class="buttons-row">
    <button class="btn-half btn-plus" id="addBtn" data-mode="main">
      <i data-lucide="plus"></i>
    </button>
    <button class="btn-half btn-stats" id="statsBtn">
      <i data-lucide="bar-chart-2"></i>
    </button>
  </div>

  <div id="statsView"></div>

  <!-- Dünner Shake-Delete-Balken -->
  <div id="deletePanel">
    <span id="deletePanelText">Klicke hier, um alle Habits zu löschen.</span>
    <button id="deleteAllBtn">Löschen</button>
  </div>
</div>

<script>
  lucide.createIcons();

  const supabaseClient = supabase.createClient(
    "https://gglgenarpskajkaanknk.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdnbGdlbmFycHNrYWprYWFua25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODA2NzAsImV4cCI6MjA3ODY1NjY3MH0.phVPaPpkiXJ0ncbRiBChpVBtY8gv0sm_MjlCJJnaSt4"
  );

  const loginScreen   = document.getElementById("loginScreen");
  const loginForm     = document.getElementById("loginForm");
  const loginError    = document.getElementById("loginError");
  const appPage       = document.getElementById("appPage");
  const btnLogin      = document.getElementById("btnLogin");
  const btnRegister   = document.getElementById("btnRegister");
  const loginOkBtn    = document.getElementById("loginOkBtn");
  const loginName     = document.getElementById("loginName");
  const loginEmail    = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const addBtnEl      = document.getElementById("addBtn");
  const statsBtnEl    = document.getElementById("statsBtn");
  const statsViewEl   = document.getElementById("statsView");
  const deletePanel   = document.getElementById("deletePanel");
  const deleteAllBtn  = document.getElementById("deleteAllBtn");

  const slotOrder = ["slot3","slot2","slot1"];

  let habits      = [];
  let currentUser = null;
  let authMode    = "login";
  let statsOpen   = false;
  let otherUser   = null;

  let deleteTimeout = null;
  let deletePanelVisible = false;

  const cycleColors = [
    "#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e",
    "#10b981","#14b8a6","#06b6d4","#0ea5e9","#3b82f6","#6366f1",
    "#8b5cf6","#a855f7","#d946ef","#ec4899","#f43f5e","#dc2626",
    "#ea580c","#ca8a04","#4d7c0f","#15803d","#047857","#0f766e",
    "#0369a1","#1d4ed8","#4338ca","#6d28d9","#7e22ce","#be185d"
  ];

  function darken(hex, f=0.55) {
    let r = parseInt(hex.slice(1,3),16)*f|0;
    let g = parseInt(hex.slice(3,5),16)*f|0;
    let b = parseInt(hex.slice(5,7),16)*f|0;
    return `rgb(${r},${g},${b})`;
  }

  function getCurrentWeekKey() {
    const now  = new Date();
    const date = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
  }

  async function ensureWeeklyReset(rows) {
    if (!currentUser || !rows || rows.length === 0) return rows;

    const weekKey    = getCurrentWeekKey();
    const storageKey = `consistency_lastWeekReset_${currentUser.id}`;
    const lastWeek   = localStorage.getItem(storageKey);

    if (lastWeek === weekKey) return rows;

    const idsToReset = [];
    rows.forEach(h => {
      const p = h.progress || 0;
      const c = h.color || "#e4e4e4";
      if (p !== 0 || c !== "#e4e4e4") {
        h.progress = 0;
        h.color    = "#e4e4e4";
        idsToReset.push(h.id);
      }
    });

    if (idsToReset.length > 0) {
      const { error } = await supabaseClient
        .from("habits")
        .update({ progress: 0, color: "#e4e4e4" })
        .in("id", idsToReset);

      if (error) console.error("weekly reset error:", error);
    }

    localStorage.setItem(storageKey, weekKey);
    return rows;
  }

  function startLoginCircleFloat() {
    if (!document.getElementById("loginCircle")) return;
    gsap.to("#loginCircle", {
      y: -6,
      duration: 2.4,
      repeat: -1,
      yoyo: true,
      ease: "sine.inOut"
    });
  }

  function showAppAfterDataLoaded() {
    // App sichtbar machen
    appPage.style.display = "block";
    gsap.fromTo(appPage, { opacity:0 }, {
      opacity:1,
      duration:0.5,
      ease:"sine.inOut"
    });

    // Login ausfaden
    gsap.to(loginScreen, {
      opacity:0,
      duration:0.45,
      ease:"sine.inOut",
      onComplete: () => {
        loginScreen.style.display = "none";
      }
    });
  }

  // LOGIN UI
  btnLogin.onclick = () => {
    authMode = "login";
    btnLogin.style.display    = "none";
    btnRegister.style.display = "none";
    loginName.style.display   = "none";
    loginForm.style.display   = "flex";
    loginError.style.display  = "none";
  };

  btnRegister.onclick = () => {
    authMode = "register";
    btnLogin.style.display    = "none";
    btnRegister.style.display = "none";
    loginName.style.display   = "block";
    loginForm.style.display   = "flex";
    loginError.style.display  = "none";
  };

  loginOkBtn.onclick = async () => {
    loginError.style.display = "none";
    const email    = loginEmail.value.trim();
    const password = loginPassword.value.trim();
    const name     = loginName.value.trim();

    if (!email || !password || (authMode === "register" && !name)) {
      loginError.textContent = "Bitte alles ausfüllen.";
      loginError.style.display = "block";
      return;
    }

    let error;

    if (authMode === "login") {
      ({ error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      }));
    } else {
      const { error: signUpError } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: {
            display_name: name
          }
        }
      });
      error = signUpError;
    }

    if (error) {
      loginError.textContent = error.message;
      loginError.style.display = "block";
      return;
    }

    const { data } = await supabaseClient.auth.getUser();
    currentUser = data.user;

    setupRealtime();
    setupShakeDetection();

    await loadHabitsFromDB();
    showAppAfterDataLoaded();
  };
  
  