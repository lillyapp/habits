<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Habit App</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Matter.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

  <style>
    :root {
      --black:#000;
      --white:#fff;
      --gray:#e5e5e5;
      --lightgray:#f2f2f2;
      --p1:#FFE8A3;
      --p2:#CFFFD8;
      --p3:#D6E5FF;
      --p4:#FFD6E8;
      --p5:#E9DAFF;
      --p6:#FFF2C7;
    }

    body {
      margin:0;
      background:var(--white);
      color:var(--black);
      font-family:system-ui,-apple-system,sans-serif;
      height:100vh;
      overflow:hidden;
      position:relative;
    }

    /* Screens */
    .screen {
      display:none;
      position:absolute;
      inset:0;
    }
    .active { display:flex; }

    /* Login */
    #loginScreen {
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }

    @keyframes pulse {
      0% {transform:scale(1);}
      50%{transform:scale(1.06);}
      100%{transform:scale(1);}
    }

    #loginCircle {
      width:30px;
      height:30px;
      background:#000;
      border-radius:50%;
      animation:pulse 2.2s ease-in-out infinite;
    }

    #loginHeadline {
      margin-top:28px;
      font-size:26px;
      font-weight:600;
      text-align:center;
      padding:0 20px;
      max-width:240px;
    }

    #loginButtonBar {
      position:absolute;
      bottom:24px;
      width:100%;
      display:flex;
      gap:14px;
      padding:0 20px;
      transition:bottom .25s ease;
      box-sizing:border-box;
    }

    .btn {
      flex:1;
      padding:14px;
      border:none;
      border-radius:20px;
      font-size:17px;
    }

    #btnLogin    {background:#000;color:#fff;}
    #btnRegister {background:#e5e5e5;}

    #loginForm {
      display:none;
      flex-direction:column;
      gap:12px;
      padding:20px;
      width:100%;
      max-width:500px;
      box-sizing:border-box;
    }

    .login-input {
      padding:12px;
      border:none;
      border-radius:12px;
      background:#e5e5e5;
      font-size:16px;
    }

    /* Main Screen */
    #mainScreen {
      flex-direction:column;
      padding:20px;
      padding-bottom:100px;
      overflow-y:auto;
      box-sizing:border-box;
    }

    #topStatsBox {
      width:100%;
      max-width:600px;
      background:#e5e5e5;
      border-radius:18px;
      padding:16px;
      margin:0 auto 20px;
      box-sizing:border-box;
    }

    .progress {
      width:100%;
      height:12px;
      background:#f2f2f2;
      border-radius:6px;
      overflow:hidden;
    }

    .progress-inner {
      width:0%;
      height:100%;
      background:#000;
      transition:width .3s ease;
    }

    #habitList {
      position:relative;
      width:100%;
      max-width:600px;
      margin:0 auto;
      height: calc(100vh - 260px);
      overflow:hidden;
    }

    .habitCard {
      position:absolute;
      width:100px;
      height:100px;
      border:3px solid #000;
      border-radius:20px;
      box-shadow:0 6px 14px rgba(0,0,0,0.12);
      display:flex;
      justify-content:center;
      align-items:center;
      text-align:center;
      font-size:15px;
      font-weight:600;
      padding:10px;
      touch-action:none;
      transition:opacity .2s ease;
    }

    #bottomActionBar {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      width:calc(100% - 40px);
      max-width:600px;
      background:#000;
      color:#fff;
      border-radius:18px;
      padding:10px 14px;
      font-size:26px;
      font-weight:600;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    #newCenterHabit {
      position:absolute;
      width:100px;
      height:100px;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:#e5e5e5;
      border:3px solid #000;
      border-radius:20px;
      display:none;
      justify-content:center;
      align-items:center;
      font-size:15px;
      font-weight:600;
      z-index:50;
    }

    #newCenterOk {
      position:absolute;
      top:calc(50% + 80px);
      left:50%;
      transform:translateX(-50%);
      background:#000;
      color:#fff;
      border:none;
      padding:8px 20px;
      border-radius:12px;
      font-size:15px;
      display:none;
      z-index:51;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="screen active">
  <div id="loginCircle"></div>
  <div id="loginHeadline">Hallo, bitte melde dich an</div>

  <div id="loginButtonBar">
    <button id="btnLogin" class="btn">Login</button>
    <button id="btnRegister" class="btn">Registrieren</button>
  </div>

  <div id="loginForm">
    <input id="loginEmail" type="email" placeholder="E-Mail" class="login-input" />
    <input id="loginPassword" type="password" placeholder="Passwort" class="login-input" />
    <button id="loginOkBtn" class="btn" style="background:#000;color:#fff;">OK</button>
  </div>
</div>

<!-- MAIN -->
<div id="mainScreen" class="screen">
  <div id="topStatsBox">
    <div class="progress"><div class="progress-inner" id="progressInner"></div></div>
  </div>

  <div id="habitList"></div>

  <div id="newCenterHabit">Neu</div>
  <button id="newCenterOk">OK</button>
</div>

<div id="bottomActionBar">+</div>

<script>
/* ------------------------------ */
/* SUPABASE */
/* ------------------------------ */
const supabaseClient = supabase.createClient(
  "https://gglgenarpskajkaanknk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdnbGdlbmFycHNrYWprYWFua25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODA2NzAsImV4cCI6MjA3ODY1NjY3MH0.phVPaPpkiXJ0ncbRiBChpVBtY8gv0sm_MjlCJJnaSt4"
);

/* ------------------------------ */
/* PHYSIK SETUP */
/* ------------------------------ */
const Engine = Matter.Engine;
const World  = Matter.World;
const Bodies = Matter.Bodies;
const Body   = Matter.Body;

let engine, world;
let habitBodies = [];
let walls = [];
let physicsReady = false;

const CARD_SIZE = 100;
const CARD_HALF = CARD_SIZE/2;

/* ruhige Physik */
const MAX_SPEED = 1.2;
const MIN_SPEED = 0.15;
const WANDER_FORCE = 0.0014;
const WANDER_INTERVAL = 260;

const habitListEl = document.getElementById("habitList");

async function initPhysics() {
  if (physicsReady) return;
  physicsReady = true;

  engine = Engine.create();
  world = engine.world;
  engine.gravity.x = 0;
  engine.gravity.y = 0;

  createBounds();

  let last = performance.now();
  function loop(now){
    const dt = now - last;
    last = now;
    Engine.update(engine, dt);

    updateDOM();
    checkEdgeCompletion();

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  setInterval(()=>applyWander(),WANDER_INTERVAL);
}

function createBounds(){
  const r = habitListEl.getBoundingClientRect();
  const w = r.width;
  const h = r.height;
  const thick = 60;

  if (walls.length){
    walls.forEach(wb=>World.remove(world,wb));
  }
  walls = [];

  const left   = Bodies.rectangle(-thick/2, h/2, thick, h+thick,{isStatic:true});
  const right  = Bodies.rectangle(w+thick/2, h/2, thick, h+thick,{isStatic:true});
  const top    = Bodies.rectangle(w/2, -thick/2, w+thick, thick,{isStatic:true});
  const bottom = Bodies.rectangle(w/2, h+thick/2, w+thick, thick,{isStatic:true});

  walls.push(left,right,top,bottom);
  World.add(world,walls);
}

function applyWander(){
  habitBodies.forEach(({body})=>{
    const vx = body.velocity.x;
    const vy = body.velocity.y;
    const speed = Math.sqrt(vx*vx+vy*vy);

    if (speed < MIN_SPEED){
      const a = Math.random()*Math.PI*2;
      Body.applyForce(body,body.position,{
        x:Math.cos(a)*WANDER_FORCE,
        y:Math.sin(a)*WANDER_FORCE
      });
      return;
    }

    if (speed > MAX_SPEED){
      Body.setVelocity(body,{x:vx*0.9,y:vy*0.9});
      return;
    }

    const a2 = Math.random()*Math.PI*2;
    Body.applyForce(body,body.position,{
      x:Math.cos(a2)*WANDER_FORCE,
      y:Math.sin(a2)*WANDER_FORCE
    });
  });
}

/* ------------------------------ */
/* LOGIN */
/* ------------------------------ */
const loginScreen = document.getElementById("loginScreen");
const mainScreen = document.getElementById("mainScreen");
const loginForm = document.getElementById("loginForm");
const loginButtonBar = document.getElementById("loginButtonBar");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");

document.getElementById("btnLogin").onclick = ()=>{
  loginForm.style.display="flex";
  loginForm.dataset.mode="login";
  loginButtonBar.style.bottom="260px";
};

document.getElementById("btnRegister").onclick = ()=>{
  loginForm.style.display="flex";
  loginForm.dataset.mode="register";
  loginButtonBar.style.bottom="260px";
};

document.getElementById("loginOkBtn").onclick = async ()=>{
  const email = loginEmail.value;
  const password = loginPassword.value;
  const mode = loginForm.dataset.mode;

  if (mode==="login"){
    const {error} = await supabaseClient.auth.signInWithPassword({email,password});
    if (!error){
      loginScreen.classList.remove("active");
      mainScreen.classList.add("active");
      await initPhysics();
      loadHabits();
    }
  }

  if (mode==="register"){
    await supabaseClient.auth.signUp({email,password});
  }
};

/* ------------------------------ */
/* HABITS */
/* ------------------------------ */
async function loadHabits(){
  const user = (await supabaseClient.auth.getUser()).data.user;
  if (!user)return;

  const {data} = await supabaseClient
    .from("habits")
    .select("*")
    .eq("user_id",user.id);

  updateProgress(data);
  const open = data.filter(x=>x.zustand!=="erledigt");

  habitBodies.forEach(({body})=>World.remove(world,body));
  habitBodies = [];
  habitListEl.innerHTML = "";

  const r = habitListEl.getBoundingClientRect();
  const w = r.width;
  const h = r.height;

  open.forEach(habit=>{
    const el = document.createElement("div");
    el.className="habitCard";
    el.textContent = habit.titel;
    el.dataset.id = habit.id;
    el.style.background = randomPastel();
    habitListEl.appendChild(el);

    const x = CARD_HALF + Math.random()*(w-CARD_SIZE);
    const y = CARD_HALF + Math.random()*(h-CARD_SIZE);

    const body = Bodies.rectangle(x,y,CARD_SIZE,CARD_SIZE,{
      frictionAir:0.015,
      restitution:0.7,
      sleepThreshold:-1,
      inertia:Infinity
    });

    body.habitId = habit.id;
    body.domEl = el;
    body.readyToComplete = false;

    World.add(world,body);
    habitBodies.push({body,el});

    Body.setVelocity(body,{
      x:(Math.random()*2-1)*0.3,
      y:(Math.random()*2-1)*0.3
    });

    attachDrag(el,body);
  });
}

function randomPastel(){
  const arr=["var(--p1)","var(--p2)","var(--p3)","var(--p4)","var(--p5)","var(--p6)"];
  return arr[Math.floor(Math.random()*arr.length)];
}

function updateDOM(){
  habitBodies.forEach(({body,el})=>{
    el.style.transform = `translate(${body.position.x-CARD_HALF}px,${body.position.y-CARD_HALF}px)`;
  });
}

async function completeHabit(id,body,el){
  World.remove(world,body);
  el.remove();
  await supabaseClient.from("habits").update({zustand:"erledigt"}).eq("id",id);
  loadHabits();
}

/* Rand-Check */
function checkEdgeCompletion(){
  const r = habitListEl.getBoundingClientRect();
  habitBodies.forEach(({body,el})=>{
    if (!body.readyToComplete)return;
    const x = body.position.x;
    const y = body.position.y;

    if (x< -50 || x>r.width+50 || y< -50 || y>r.height+50){
      completeHabit(body.habitId,body,el);
    }
  });
}

/* ------------------------------ */
/* DRAG */
/* ------------------------------ */
function attachDrag(el,body){
  let dragging=false;

  const getRect=()=>habitListEl.getBoundingClientRect();

  el.addEventListener("touchstart",e=>{
    dragging=true;
    Body.setVelocity(body,{x:0,y:0});
    e.preventDefault();
  },{passive:false});

  el.addEventListener("touchmove",e=>{
    if(!dragging)return;

    const t=e.touches[0];
    const r=getRect();

    const x=t.clientX-r.left;
    const y=t.clientY-r.top;

    Body.setPosition(body,{x,y});

    const hitEdge =
      x<20 || x>r.width-20 || y<20 || y>r.height-20;

    if(hitEdge){
      el.style.opacity="0.5";
      body.readyToComplete=true;
    } else {
      el.style.opacity="1";
      body.readyToComplete=false;
    }

    e.preventDefault();
  },{passive:false});

  el.addEventListener("touchend",()=>{
    dragging=false;
    if (!body.readyToComplete){
      el.style.opacity="1";
    }
  });
}

/* ------------------------------ */
/* PLUS BUTTON */
/* ------------------------------ */
const newCenter = document.getElementById("newCenterHabit");
const newCenterOk = document.getElementById("newCenterOk");

document.getElementById("bottomActionBar").onclick=()=>{
  newCenter.style.display="flex";
  newCenterOk.style.display="block";

  habitBodies.forEach(({body})=>{
    const a=Math.random()*Math.PI*2;
    Body.applyForce(body,body.position,{
      x:Math.cos(a)*0.03,
      y:Math.sin(a)*0.03
    });
  });
};

newCenterOk.onclick=async()=>{
  const user=(await supabaseClient.auth.getUser()).data.user;
  await supabaseClient.from("habits").insert({
    user_id:user.id,
    titel:"Neue Aufgabe",
    zustand:"offen"
  });

  newCenter.style.display="none";
  newCenterOk.style.display="none";
  loadHabits();
};

/* ------------------------------ */
/* Progress */
/* ------------------------------ */
function updateProgress(list){
  const done=list.filter(x=>x.zustand==="erledigt").length;
  const total=list.length;
  const pct=total?done/total*100:0;
  document.getElementById("progressInner").style.width=pct+"%";
}
</script>
</body>
</html>